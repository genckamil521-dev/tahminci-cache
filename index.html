<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CanlÄ± Tahminci â€” CanlÄ± MaÃ§ Analizi</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Barlow+Condensed:ital,wght@0,400;0,600;0,700;0,800;0,900;1,700&family=Barlow:wght@300;400;500;600&family=JetBrains+Mono:wght@400;600&display=swap');

  :root {
    --bg: #05080f;
    --s1: #0a0e1a;
    --s2: #0f1525;
    --s3: #151d30;
    --border: rgba(255,255,255,0.07);
    --border2: rgba(255,255,255,0.12);
    --green: #00f0a0;
    --green-dim: rgba(0,240,160,0.08);
    --red: #ff3d5a;
    --red-dim: rgba(255,61,90,0.08);
    --gold: #ffc85a;
    --gold-dim: rgba(255,200,90,0.08);
    --blue: #4da6ff;
    --blue-dim: rgba(77,166,255,0.08);
    --text: #dce6f5;
    --muted: #4a5a78;
    --live: #ff3d5a;
  }

  *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Barlow', sans-serif;
    font-weight: 400;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Ambient glow arka plan */
  body::before {
    content:''; position:fixed; inset:0; z-index:0; pointer-events:none;
    background:
      radial-gradient(ellipse 900px 600px at 15% 20%, rgba(0,240,160,0.035) 0%, transparent 65%),
      radial-gradient(ellipse 700px 500px at 85% 80%, rgba(255,61,90,0.035) 0%, transparent 65%),
      radial-gradient(ellipse 500px 400px at 50% 50%, rgba(77,166,255,0.02) 0%, transparent 70%);
  }

  /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  header {
    position: sticky; top:0; z-index:200;
    display: flex; align-items:center; justify-content:space-between;
    padding: 0 32px; height: 60px;
    background: rgba(5,8,15,0.88);
    backdrop-filter: blur(24px) saturate(1.4);
    border-bottom: 1px solid var(--border);
  }

  .logo {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 900; font-style: italic;
    font-size: 26px; letter-spacing: 1px;
    color: var(--green);
    text-shadow: 0 0 40px rgba(0,240,160,0.5);
    cursor: pointer;
    user-select: none;
  }
  .logo span { color: var(--text); font-style: normal; }

  .header-right { display:flex; align-items:center; gap:14px; }

  .live-badge {
    display:flex; align-items:center; gap:6px;
    background: rgba(255,61,90,0.1);
    border: 1px solid rgba(255,61,90,0.25);
    padding: 5px 12px; border-radius:4px;
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700; font-size:12px; letter-spacing:2px;
    color: var(--red);
  }
  .live-dot {
    width:6px; height:6px; background:var(--red); border-radius:50%;
    animation: blink 1s step-end infinite;
  }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }

  .last-update {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px; color: var(--muted);
    letter-spacing: 0.5px;
  }

  .refresh-btn {
    background: transparent;
    border: 1px solid var(--border2);
    color: var(--muted);
    padding: 5px 14px; border-radius:4px;
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 600; font-size:13px; letter-spacing:1px;
    cursor:pointer; transition:all 0.15s;
  }
  .refresh-btn:hover { border-color: var(--green); color: var(--green); }
  .refresh-btn:disabled { opacity:0.3; cursor:not-allowed; }

  /* â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  main {
    position:relative; z-index:1;
    max-width: 1100px; margin:0 auto;
    padding: 28px 20px;
  }

  .section-title {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 600; font-size:11px; letter-spacing:3px;
    color: var(--muted); text-transform:uppercase;
    margin-bottom:16px; padding-bottom:10px;
    border-bottom: 1px solid var(--border);
  }

  /* â”€â”€ LOADING / EMPTY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .loading {
    display:flex; flex-direction:column;
    align-items:center; justify-content:center;
    padding:80px 20px; gap:16px;
  }
  .spinner {
    width:36px; height:36px;
    border: 2px solid var(--s3);
    border-top-color: var(--green);
    border-radius:50%; animation:spin 0.7s linear infinite;
  }
  @keyframes spin { to { transform:rotate(360deg); } }
  .loading p { color:var(--muted); font-size:13px; }
  .error-box, .empty-box {
    background:var(--s1); border:1px solid var(--border);
    border-radius:8px; padding:40px; text-align:center;
  }
  .empty-box .icon { font-size:40px; margin-bottom:12px; }
  .empty-box h3 { color:var(--text); margin-bottom:6px; font-family:'Barlow Condensed',sans-serif; font-size:20px; letter-spacing:1px; }
  .empty-box p { color:var(--muted); font-size:13px; }

  /* â”€â”€ CONTROLS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .controls-bar {
    display:flex; align-items:center; justify-content:space-between;
    margin-bottom:16px; flex-wrap:wrap; gap:10px;
  }
  .legend { display:flex; gap:16px; flex-wrap:wrap; }
  .legend-item { display:flex; align-items:center; gap:5px; font-size:11px; color:var(--muted); }
  .legend-dot { width:7px; height:7px; border-radius:1px; }
  .filter-right { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  .controls-bar select {
    background: var(--s2); border: 1px solid var(--border);
    color: var(--text); padding:6px 10px; border-radius:4px;
    font-size:12px; font-family:'Barlow',sans-serif;
    cursor:pointer; outline:none; transition:border-color 0.15s;
  }
  .controls-bar select:hover { border-color:var(--border2); }
  .match-count {
    font-family:'JetBrains Mono',monospace; font-size:11px; color:var(--muted);
    background:var(--s2); border:1px solid var(--border);
    padding:6px 10px; border-radius:4px;
  }

  /* â”€â”€ MATCH LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .matches { display:flex; flex-direction:column; gap:2px; margin-bottom:40px; }

  /* â”€â”€ MATCH CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .match-card {
    background: var(--s1);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative; overflow:hidden;
    animation: card-in 0.4s ease both;
  }
  @keyframes card-in {
    from { opacity:0; transform:translateY(12px); }
    to   { opacity:1; transform:translateY(0); }
  }

  /* Ãœst renkli ÅŸerit */
  .match-card::before {
    content:''; position:absolute;
    top:0; left:0; right:0; height:2px;
    background: linear-gradient(90deg, var(--green), transparent);
    opacity:0; transition:opacity 0.2s;
    border-radius:10px 10px 0 0;
  }
  .match-card:hover::before, .match-card.active::before { opacity:1; }
  .match-card:hover {
    border-color: rgba(255,255,255,0.1);
    background: var(--s2);
  }
  .match-card.active {
    border-color: rgba(0,240,160,0.2);
    background: var(--s2);
  }

  /* Kart iÃ§ padding bÃ¶lgesi */
  .card-inner { padding: 18px 22px 20px; }

  /* â”€â”€ MATCH HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .match-header {
    display:flex; align-items:center; justify-content:space-between;
    margin-bottom:16px;
  }
  .league-info {
    display:flex; align-items:center; gap:7px;
    font-size:11px; color:var(--muted); font-weight:500; letter-spacing:0.5px;
  }
  .league-logo { width:16px; height:16px; border-radius:2px; object-fit:contain; }

  .match-minute {
    font-family:'Barlow Condensed',sans-serif;
    font-weight:700; font-size:13px; letter-spacing:1px;
    color:var(--red); background:rgba(255,61,90,0.1);
    padding:3px 10px; border-radius:3px;
    border-left:2px solid var(--red);
  }
  .match-minute.ht {
    color:var(--gold); background:rgba(255,200,90,0.1);
    border-color:var(--gold);
  }

  /* â”€â”€ SKOR SATIRI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .score-row {
    display:grid; grid-template-columns:1fr auto 1fr;
    align-items:center; gap:12px; margin-bottom:20px;
  }
  .team { display:flex; flex-direction:column; gap:4px; }
  .team.home { align-items:flex-start; }
  .team.away { align-items:flex-end; }
  .team-logo-name { display:flex; align-items:center; gap:7px; }
  .team.away .team-logo-name { flex-direction:row-reverse; }
  .team-logo { width:24px; height:24px; object-fit:contain; }
  .team-name {
    font-family:'Barlow Condensed',sans-serif;
    font-weight:800; font-size:22px; letter-spacing:0.5px; line-height:1;
    color: var(--text);
  }

  .score-box { display:flex; align-items:center; gap:8px; }
  .score-num {
    font-family:'Barlow Condensed',sans-serif;
    font-weight:900; font-size:56px; line-height:1;
    color: var(--text);
    transition: transform 0.3s, color 0.4s;
  }
  .score-sep {
    font-family:'Barlow Condensed',sans-serif;
    font-weight:300; font-size:40px; color:var(--muted);
  }

  /* â”€â”€ BASKÃœ BARI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .goal-prob-section { margin-bottom:14px; }
  .goal-prob-label {
    display:flex; justify-content:space-between; align-items:center;
    margin-bottom:6px; font-size:11px; color:var(--muted); letter-spacing:0.3px;
  }
  .goal-prob-label .highlight {
    color:var(--gold); font-weight:700; font-size:12px;
    font-family:'Barlow Condensed',sans-serif; letter-spacing:1px;
  }
  .prob-track {
    height:6px; background:rgba(255,255,255,0.04);
    border-radius:3px; overflow:hidden; position:relative;
  }
  .prob-fill-home {
    position:absolute; left:0; top:0; bottom:0; border-radius:3px;
    background: linear-gradient(90deg, rgba(0,240,160,0.7), rgba(0,240,160,0.2));
    transition:width 1.2s cubic-bezier(0.4,0,0.2,1);
  }
  .prob-fill-away {
    position:absolute; right:0; top:0; bottom:0; border-radius:3px;
    background: linear-gradient(270deg, rgba(255,61,90,0.7), rgba(255,61,90,0.2));
    transition:width 1.2s cubic-bezier(0.4,0,0.2,1);
  }

  /* â”€â”€ Ä°STATÄ°STÄ°K GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .stats-row {
    display:grid; grid-template-columns:repeat(6,1fr);
    gap:1px; margin-top:14px;
    background: var(--border);
    border-radius:6px; overflow:hidden;
  }
  .stat-item {
    background: var(--s2);
    padding: 10px 6px; text-align:center;
  }
  .stat-item:first-child { border-radius:6px 0 0 6px; }
  .stat-item:last-child  { border-radius:0 6px 6px 0; }

  .stat-label {
    font-size:9px; color:var(--muted);
    letter-spacing:0.8px; text-transform:uppercase;
    margin-bottom:5px; font-weight:600;
  }
  .stat-values {
    display:flex; align-items:center; justify-content:center;
    gap:5px; font-family:'JetBrains Mono',monospace;
    font-size:13px; font-weight:600;
  }
  .stat-home { color:var(--green); }
  .stat-away { color:var(--red); }
  .stat-sep  { color:var(--muted); font-size:10px; }

  /* â”€â”€ ROZET / TAG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .hot-badge {
    display:inline-flex; align-items:center; gap:4px;
    background:rgba(255,200,90,0.1); border:1px solid rgba(255,200,90,0.2);
    color:var(--gold); padding:2px 8px; border-radius:3px;
    font-family:'Barlow Condensed',sans-serif;
    font-size:10px; font-weight:700; letter-spacing:1px;
    animation: glow-pulse 2s ease infinite;
  }
  @keyframes glow-pulse {
    0%,100%{box-shadow:0 0 0 0 rgba(255,200,90,0)}
    50%{box-shadow:0 0 12px 2px rgba(255,200,90,0.12)}
  }
  .tag { font-size:10px; padding:2px 7px; border-radius:3px; font-weight:600; letter-spacing:0.5px; }
  .tag-high { background:var(--green-dim); color:var(--green); border:1px solid rgba(0,240,160,0.2); }
  .tag-mid  { background:var(--gold-dim);  color:var(--gold);  border:1px solid rgba(255,200,90,0.2); }
  .tag-low  { background:rgba(74,90,120,0.15); color:var(--muted); border:1px solid var(--border); }

  /* â”€â”€ ANALÄ°Z KUTUSU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .insight-wrapper { margin-top:8px; display:flex; flex-direction:column; gap:6px; }

  .match-insight {
    border-radius:8px;
    border:1px solid;
    overflow:hidden;
    animation: fade-up 0.3s ease both;
    font-size:13px; line-height:1.55;
  }
  @keyframes fade-up { from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:translateY(0)} }

  /* Ãœst baÅŸlÄ±k ÅŸeridi */
  .insight-header {
    display:flex; align-items:center; gap:8px;
    padding:7px 12px;
    font-family:'Barlow Condensed',sans-serif;
    font-weight:700; font-size:11px; letter-spacing:1.5px;
    text-transform:uppercase;
  }
  .insight-header-icon { font-size:14px; }

  /* Ä°Ã§erik alanÄ± */
  .insight-content { padding:10px 14px 12px; }

  /* BÃ¼yÃ¼k bahis Ã¶nerisi satÄ±rÄ± */
  .bet-call {
    font-family:'Barlow Condensed',sans-serif;
    font-weight:800; font-size:18px; letter-spacing:0.5px;
    margin-bottom:5px; line-height:1.2;
  }
  /* AÃ§Ä±klama metni */
  .bet-reason {
    font-size:12px; line-height:1.6; opacity:0.85;
    margin-bottom:8px;
  }
  .bet-reason strong { font-weight:700; filter:brightness(1.15); }

  .insight-tags { display:flex; flex-wrap:wrap; gap:4px; }
  .insight-tag {
    font-size:10px; padding:3px 8px; border-radius:3px;
    background:rgba(255,255,255,0.07);
    border:1px solid rgba(255,255,255,0.1);
    color:inherit; font-weight:700; letter-spacing:0.4px;
    font-family:'Barlow Condensed',sans-serif;
  }

  /* Renk temalarÄ± */
  .match-insight.level-hot {
    background:rgba(255,61,90,0.04); border-color:rgba(255,61,90,0.3);
  }
  .match-insight.level-hot .insight-header {
    background:rgba(255,61,90,0.12); color:#ff8fa0;
  }
  .match-insight.level-hot .insight-content { color:#ffccd5; }

  .match-insight.level-warm {
    background:rgba(255,200,90,0.04); border-color:rgba(255,200,90,0.25);
  }
  .match-insight.level-warm .insight-header {
    background:rgba(255,200,90,0.1); color:#ffc85a;
  }
  .match-insight.level-warm .insight-content { color:#ffe8a8; }

  .match-insight.level-calm {
    background:rgba(0,240,160,0.03); border-color:rgba(0,240,160,0.2);
  }
  .match-insight.level-calm .insight-header {
    background:rgba(0,240,160,0.08); color:#00f0a0;
  }
  .match-insight.level-calm .insight-content { color:#b0f5e0; }

  .match-insight.level-low {
    background:rgba(74,90,120,0.06); border-color:rgba(74,90,120,0.2);
  }
  .match-insight.level-low .insight-header {
    background:rgba(74,90,120,0.1); color:#4a5a78;
  }
  .match-insight.level-low .insight-content { color:#4a5a78; }

  /* â”€â”€ CANLI BÄ°LDÄ°RÄ°M BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #alertBanner {
    position:fixed; bottom:24px; right:24px; z-index:500;
    max-width:360px; width:calc(100% - 48px);
    background:var(--s2);
    border:1px solid rgba(255,200,90,0.4);
    border-radius:10px; overflow:hidden;
    box-shadow:0 16px 48px rgba(0,0,0,0.7), 0 0 0 1px rgba(255,200,90,0.1);
    transform:translateY(120%); opacity:0;
    transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1), opacity 0.3s ease;
  }
  #alertBanner.show { transform:translateY(0); opacity:1; }
  .alert-stripe {
    height:3px;
    background:linear-gradient(90deg, var(--gold), var(--red));
  }
  .alert-body { padding:14px 16px 14px; }
  .alert-top {
    display:flex; align-items:center; justify-content:space-between;
    margin-bottom:8px;
  }
  .alert-label {
    display:flex; align-items:center; gap:6px;
    font-family:'Barlow Condensed',sans-serif;
    font-weight:700; font-size:10px; letter-spacing:2px;
    color:var(--gold); text-transform:uppercase;
  }
  .alert-close {
    background:none; border:none; color:var(--muted);
    font-size:16px; cursor:pointer; line-height:1;
    transition:color 0.15s; padding:0;
  }
  .alert-close:hover { color:var(--text); }
  .alert-match {
    font-size:11px; color:var(--muted); margin-bottom:5px;
    font-family:'Barlow Condensed',sans-serif; letter-spacing:0.5px;
  }
  .alert-call {
    font-family:'Barlow Condensed',sans-serif;
    font-weight:900; font-size:22px; letter-spacing:0.5px;
    color:var(--text); line-height:1.1; margin-bottom:5px;
  }
  .alert-call span { color:var(--gold); }
  .alert-why {
    font-size:12px; color:var(--muted); line-height:1.5;
  }
  .alert-dot { width:6px; height:6px; background:var(--gold); border-radius:50%; animation:blink 1s step-end infinite; }

  /* â”€â”€ Ã–ZET KARTLAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .summary-grid {
    display:grid; grid-template-columns:repeat(3,1fr);
    gap:10px; margin-top:28px;
  }
  .summary-card {
    background:var(--s1); border:1px solid var(--border);
    border-radius:8px; padding:20px 16px; text-align:center;
    position:relative; overflow:hidden;
  }
  .summary-card::after {
    content:''; position:absolute;
    bottom:0; left:0; right:0; height:2px;
  }
  .summary-card:nth-child(1)::after { background:var(--green); }
  .summary-card:nth-child(2)::after { background:var(--gold); }
  .summary-card:nth-child(3)::after { background:var(--red); }
  .summary-card .big-num {
    font-family:'Barlow Condensed',sans-serif;
    font-weight:900; font-size:52px; line-height:1; margin-bottom:4px;
  }
  .summary-card .label {
    font-size:10px; color:var(--muted);
    letter-spacing:1.5px; text-transform:uppercase; font-weight:600;
  }

  /* â”€â”€ TOOLTIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .tip-wrap {
    position:relative; display:inline-flex;
    align-items:center; gap:3px; cursor:help;
  }
  .tip-icon {
    width:13px; height:13px; background:rgba(74,90,120,0.3);
    border-radius:50%; font-size:8px; font-weight:700; color:var(--muted);
    display:inline-flex; align-items:center; justify-content:center;
    flex-shrink:0; transition:background 0.15s;
  }
  .tip-wrap:hover .tip-icon { background:rgba(0,240,160,0.2); color:var(--green); }
  .tip-box {
    position:absolute; bottom:calc(100% + 7px); left:50%; transform:translateX(-50%);
    background:#121926; border:1px solid var(--border2);
    border-radius:6px; padding:9px 11px; width:190px;
    font-size:11px; line-height:1.55; color:var(--text);
    font-family:'Barlow',sans-serif; font-weight:400;
    pointer-events:none; opacity:0; transition:opacity 0.15s; z-index:999;
    box-shadow:0 12px 32px rgba(0,0,0,0.6);
  }
  .tip-box::after {
    content:''; position:absolute; top:100%; left:50%; transform:translateX(-50%);
    border:5px solid transparent; border-top-color:#121926;
  }
  .tip-wrap:hover .tip-box { opacity:1; }

  /* â”€â”€ BÄ°LGÄ° PANELÄ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .info-panel {
    margin-top:36px; background:var(--s1);
    border:1px solid var(--border); border-radius:8px;
  }
  .info-panel summary {
    padding:14px 20px; cursor:pointer;
    font-family:'Barlow Condensed',sans-serif;
    font-weight:700; font-size:13px; letter-spacing:1.5px;
    color:var(--muted); text-transform:uppercase; list-style:none;
    transition:color 0.15s;
  }
  .info-panel summary:hover { color:var(--text); }
  .info-grid {
    display:grid; grid-template-columns:repeat(2,1fr);
    gap:1px; background:var(--border);
    border-top:1px solid var(--border);
  }
  .info-item {
    background:var(--s1); padding:16px 20px;
  }
  .info-item-header {
    display:flex; align-items:center; gap:8px; margin-bottom:6px;
  }
  .info-emoji { font-size:14px; }
  .info-item-title {
    font-family:'Barlow Condensed',sans-serif;
    font-weight:700; font-size:13px; letter-spacing:0.5px; color:var(--text);
  }
  .info-item-desc {
    font-size:12px; color:var(--muted); line-height:1.65;
  }
  .info-item-desc strong { color:var(--text); }

  /* â”€â”€ TELEGRAM POPUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .tg-popup-overlay {
    position:fixed; inset:0; z-index:999;
    background:rgba(0,0,0,0.7);
    backdrop-filter:blur(8px);
    display:flex; align-items:center; justify-content:center;
    opacity:0; pointer-events:none;
    transition:opacity 0.25s ease;
  }
  .tg-popup-overlay.show { opacity:1; pointer-events:all; }
  .tg-popup {
    background:var(--s2);
    border:1px solid var(--border2);
    border-radius:12px; padding:32px 28px;
    max-width:360px; width:90%;
    text-align:center; position:relative;
    transform:translateY(16px) scale(0.97);
    transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
    box-shadow:0 32px 80px rgba(0,0,0,0.7);
  }
  .tg-popup-overlay.show .tg-popup { transform:translateY(0) scale(1); }
  .tg-popup-close {
    position:absolute; top:14px; right:16px;
    background:none; border:none; color:var(--muted);
    font-size:18px; cursor:pointer; transition:color 0.15s;
  }
  .tg-popup-close:hover { color:var(--text); }
  .tg-icon {
    width:56px; height:56px;
    background:linear-gradient(135deg,#2AABEE,#229ED9);
    border-radius:50%; display:flex; align-items:center; justify-content:center;
    margin:0 auto 14px; font-size:28px;
    box-shadow:0 8px 24px rgba(42,171,238,0.3);
  }
  .tg-popup h2 {
    font-family:'Barlow Condensed',sans-serif;
    font-weight:800; font-size:22px; letter-spacing:1px;
    color:var(--text); margin-bottom:8px;
  }
  .tg-popup p { font-size:13px; color:var(--muted); line-height:1.65; margin-bottom:20px; }
  .tg-popup p strong { color:var(--text); }
  .tg-join-btn {
    display:inline-flex; align-items:center; gap:8px;
    background:linear-gradient(135deg,#2AABEE,#229ED9);
    color:#fff; border:none; border-radius:6px;
    padding:12px 24px; font-size:14px; font-weight:700;
    cursor:pointer; font-family:'Barlow',sans-serif;
    text-decoration:none; transition:all 0.2s; width:100%;
    justify-content:center;
    box-shadow:0 6px 20px rgba(42,171,238,0.25);
  }
  .tg-join-btn:hover { transform:translateY(-2px); box-shadow:0 10px 28px rgba(42,171,238,0.4); }
  .tg-members {
    display:flex; align-items:center; justify-content:center;
    gap:5px; margin-top:12px; font-size:11px; color:var(--muted);
  }
  .tg-members-dot {
    width:6px; height:6px;
    background:var(--green); border-radius:50%;
    animation:blink 1s step-end infinite;
  }

  /* â”€â”€ API BÄ°LGÄ° NOTU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .api-note {
    margin-top:20px; padding:10px 14px;
    background:var(--green-dim); border:1px solid rgba(0,240,160,0.1);
    border-radius:6px; font-size:11px; color:var(--muted); text-align:center;
  }

  /* â”€â”€ MOBILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media (max-width: 700px) {
    header { padding: 0 16px; }
    main   { padding: 16px 12px; }
    .stats-row { grid-template-columns: repeat(3,1fr); }
    .score-num { font-size:42px; }
    .team-name { font-size:16px; }
    .info-grid { grid-template-columns:1fr; }
    .summary-grid { grid-template-columns:repeat(3,1fr); gap:6px; }
    .card-inner { padding:14px 16px 16px; }
  }

  /* â”€â”€ FIRSAT BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #opportunity-banner {
    display: none;
    margin-bottom: 16px;
    background: linear-gradient(135deg, rgba(255,200,90,0.12), rgba(255,61,90,0.08));
    border: 1px solid rgba(255,200,90,0.3);
    border-radius: 8px;
    padding: 0;
    overflow: hidden;
    animation: fade-up 0.4s ease both;
    cursor: pointer;
  }
  #opportunity-banner.show { display:block; }
  .banner-inner {
    display: flex; align-items: center; gap: 0;
  }
  .banner-left {
    background: var(--gold);
    color: #000;
    padding: 16px 18px;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    gap: 2px; min-width: 80px; text-align: center;
    flex-shrink: 0;
  }
  .banner-left .banner-icon { font-size: 22px; line-height:1; }
  .banner-left .banner-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 900; font-size: 9px; letter-spacing: 1.5px;
    text-transform: uppercase; color: rgba(0,0,0,0.6);
  }
  .banner-body {
    padding: 14px 18px; flex: 1;
  }
  .banner-match {
    font-size: 11px; color: var(--muted); margin-bottom: 4px;
    font-family: 'Barlow Condensed', sans-serif; letter-spacing: 0.5px;
  }
  .banner-action {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 800; font-size: 20px; letter-spacing: 0.5px;
    color: var(--gold); line-height: 1.2;
  }
  .banner-reason {
    font-size: 11px; color: var(--muted); margin-top: 4px; line-height: 1.4;
  }
  .banner-close {
    padding: 14px 16px; background: none; border: none;
    color: var(--muted); font-size: 16px; cursor: pointer;
    flex-shrink: 0; transition: color 0.15s; align-self: stretch;
    display: flex; align-items: center;
  }
  .banner-close:hover { color: var(--text); }
  .banner-minute {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px; color: var(--red);
    background: rgba(255,61,90,0.1); border: 1px solid rgba(255,61,90,0.2);
    padding: 2px 6px; border-radius: 3px; margin-left: 6px;
  }

  /* â”€â”€ HEMEN OYNA BUTONU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .banner-cta-wrap {
    border-top: 1px solid rgba(255,200,90,0.15);
    padding: 12px 18px;
    display: flex; align-items: center; justify-content: space-between;
    gap: 12px; background: rgba(0,0,0,0.15);
  }
  .banner-cta-hint {
    font-size: 11px; color: var(--muted); line-height: 1.4; flex: 1;
    font-family: 'Barlow', sans-serif;
  }
  .banner-cta-hint strong { color: var(--gold); }
  .banner-play-btn {
    display: inline-flex; align-items: center; gap: 8px;
    background: linear-gradient(135deg, #ffc85a, #ff9a00);
    color: #000; border: none; border-radius: 6px;
    padding: 11px 22px; cursor: pointer; flex-shrink: 0;
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 900; font-size: 16px; letter-spacing: 1px;
    text-transform: uppercase;
    box-shadow: 0 4px 20px rgba(255,180,0,0.35);
    transition: all 0.15s ease;
    position: relative; overflow: hidden;
    text-decoration: none;
  }
  .banner-play-btn::before {
    content: '';
    position: absolute; top: 0; left: -100%;
    width: 60%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: btn-shine 2.2s ease infinite;
  }
  @keyframes btn-shine {
    0%   { left: -100%; }
    50%  { left: 160%; }
    100% { left: 160%; }
  }
  .banner-play-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 28px rgba(255,180,0,0.5);
  }
  .banner-play-btn:active { transform: translateY(0); }
  .btn-arrow { font-size: 18px; }
  .banner-disclaimer {
    font-size: 9px; color: var(--muted); text-align: center;
    padding: 6px 18px 8px;
    opacity: 0.5; font-family: 'Barlow', sans-serif;
    letter-spacing: 0.3px;
  }

  /* â”€â”€ AI ANALÄ°Z PANELI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #ai-panel {
    display: none;
    margin-bottom: 16px;
    border: 1px solid rgba(77,166,255,0.25);
    border-radius: 8px;
    overflow: hidden;
    animation: fade-up 0.35s ease both;
  }
  #ai-panel.show { display: block; }

  .ai-panel-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 16px;
    background: rgba(77,166,255,0.08);
    border-bottom: 1px solid rgba(77,166,255,0.12);
  }
  .ai-panel-title {
    display: flex; align-items: center; gap: 8px;
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 800; font-size: 13px; letter-spacing: 1px;
    color: var(--blue);
  }
  .ai-panel-title .ai-dot {
    width: 7px; height: 7px; border-radius: 50%;
    background: var(--blue);
    animation: blink 1.2s ease infinite;
  }
  .ai-panel-close {
    background: none; border: none; color: var(--muted);
    font-size: 14px; cursor: pointer; transition: color 0.15s;
  }
  .ai-panel-close:hover { color: var(--text); }

  .ai-panel-body {
    padding: 14px 18px;
    background: rgba(10,14,26,0.6);
  }
  .ai-panel-context {
    font-size: 10px; color: var(--muted); margin-bottom: 8px;
    font-family: 'Barlow Condensed', sans-serif; letter-spacing: 0.5px;
  }
  .ai-panel-text {
    font-size: 13px; line-height: 1.7; color: var(--text);
    min-height: 40px;
  }
  .ai-panel-text.loading {
    display: flex; align-items: center; gap: 10px; color: var(--muted);
  }
  .ai-spinner {
    width: 14px; height: 14px;
    border: 2px solid rgba(77,166,255,0.2);
    border-top-color: var(--blue);
    border-radius: 50%; animation: spin 0.7s linear infinite;
    flex-shrink: 0;
  }
  .ai-panel-text strong { color: var(--gold); }
  .ai-panel-text em     { color: var(--green); font-style: normal; }

  .ai-panel-footer {
    padding: 8px 18px 10px;
    display: flex; align-items: center; justify-content: space-between;
    border-top: 1px solid rgba(77,166,255,0.08);
  }
  .ai-model-tag {
    font-size: 9px; color: var(--muted); letter-spacing: 0.5px;
    font-family: 'JetBrains Mono', monospace;
  }
  .ai-refresh-btn {
    background: none; border: 1px solid rgba(77,166,255,0.2);
    color: var(--blue); padding: 3px 10px; border-radius: 3px;
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700; font-size: 10px; letter-spacing: 0.5px;
    cursor: pointer; transition: all 0.15s;
  }
  .ai-refresh-btn:hover { background: rgba(77,166,255,0.1); }
  .ai-refresh-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  /* AI butonu banner iÃ§inde */
  .banner-ai-btn {
    display: inline-flex; align-items: center; gap: 6px;
    background: rgba(77,166,255,0.1);
    border: 1px solid rgba(77,166,255,0.25);
    color: var(--blue); padding: 6px 14px; border-radius: 4px;
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700; font-size: 12px; letter-spacing: 0.5px;
    cursor: pointer; transition: all 0.15s; white-space: nowrap;
  }
  .banner-ai-btn:hover { background: rgba(77,166,255,0.18); }
  .banner-ai-btn:disabled { opacity: 0.4; cursor: not-allowed; }

</style>
</head>
<body>


<!-- CanlÄ± Bildirim Banner -->
<div id="alertBanner">
  <div class="alert-stripe"></div>
  <div class="alert-body">
    <div class="alert-top">
      <div class="alert-label"><div class="alert-dot"></div> EN Ä°YÄ° FIRSAT</div>
      <button class="alert-close" onclick="document.getElementById('alertBanner').classList.remove('show')">âœ•</button>
    </div>
    <div class="alert-match" id="alertMatch">â€”</div>
    <div class="alert-call" id="alertCall">â€”</div>
    <div class="alert-why" id="alertWhy">â€”</div>
  </div>
</div>

<!-- Telegram Popup -->
<div class="tg-popup-overlay" id="tgPopup" onclick="if(event.target===this)this.classList.remove('show')">
  <div class="tg-popup">
    <button class="tg-popup-close" onclick="document.getElementById('tgPopup').classList.remove('show')">âœ•</button>
    <div class="tg-icon">âœˆï¸</div>
    <h2>CanlÄ± Tahminci</h2>
    <p>
      <strong>GÃ¼nlÃ¼k Ã¼cretsiz tahminler, canlÄ± maÃ§ analizleri</strong> ve toplulukla birlikte maÃ§ keyfi iÃ§in Telegram kanalÄ±mÄ±za katÄ±l!
    </p>
    <a class="tg-join-btn" href="https://t.me/canlitahminci" target="_blank" rel="noopener">
      âœˆï¸ &nbsp; Kanala KatÄ±l
    </a>
    <div class="tg-members">
      <div class="tg-members-dot"></div>
      @canlitahminci
    </div>
  </div>
</div>

<header>
  <div class="logo" style="cursor:pointer" onclick="document.getElementById('tgPopup').classList.add('show')">CanlÄ±<span>Tahminci</span></div>
  <div class="header-right">
    <button class="refresh-btn" onclick="loadMatches()" id="refreshBtn">âŸ³ Yenile</button>
    <div class="live-badge"><div class="live-dot"></div>CANLI</div>
    <div class="last-update" id="clock">â€” : â€”</div>
  </div>
</header>

<main>
  <div class="section-title">CANLI MAÃ‡LAR â€” GOL Ä°HTÄ°MALÄ° ANALÄ°ZÄ°</div>

  <div class="controls-bar">
    <div class="legend">
      <div class="legend-item"><div class="legend-dot" style="background:var(--accent)"></div>Ev Sahibi</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--accent2)"></div>Deplasman</div>
    </div>
    <div class="filter-right">
      <select id="leagueFilter" onchange="applyFilters()">
        <option value="all">ğŸŒ TÃ¼m Ligler</option>
      </select>
      <select id="sortFilter" onchange="applyFilters()">
        <option value="prob">ğŸ¯ Gol Ä°htimaline GÃ¶re</option>
        <option value="minute">â±ï¸ Dakikaya GÃ¶re</option>
        <option value="league">ğŸ† Lige GÃ¶re</option>
      </select>
      <div class="match-count" id="matchCount">â€” maÃ§</div>
    </div>
  </div>

  <div id="opportunity-banner">
    <div class="banner-inner">
      <div class="banner-left">
        <div class="banner-icon">ğŸ”¥</div>
        <div class="banner-label">En Ä°yi FÄ±rsat</div>
      </div>
      <div class="banner-body">
        <div class="banner-match" id="banner-match">â€”</div>
        <div class="banner-action" id="banner-action">â€”</div>
        <div class="banner-reason" id="banner-reason">â€”</div>
      </div>
      <button class="banner-close" onclick="document.getElementById('opportunity-banner').classList.remove('show')">âœ•</button>
    </div>
    <div class="banner-cta-wrap">
      <div class="banner-cta-hint">
        Bu fÄ±rsat istatistiklere gÃ¶re seÃ§ildi â€” <strong>en yÃ¼ksek beklenti bu maÃ§ta.</strong>
      </div>
      <div style="display:flex;gap:8px;flex-shrink:0;">
        <button class="banner-ai-btn" id="banner-ai-btn" onclick="runAIAnalysis()">
          ğŸ¤– AI Analizi
        </button>
        <a class="banner-play-btn" id="banner-play-btn" href="https://gir.gg/cevdet" target="_blank" rel="noopener">
          <span class="btn-arrow">â–¶</span> HEMEN OYNA
        </a>
      </div>
    </div>
    <div class="banner-disclaimer">Sorumlu oynayÄ±n. 18+ | CanlÄ± Tahminci tavsiye verir, bahis kararÄ± size aittir.</div>
  </div>

  <!-- AI Analiz Paneli -->
  <div id="ai-panel">
    <div class="ai-panel-header">
      <div class="ai-panel-title">
        <div class="ai-dot"></div>
        ğŸ¤– YAPAY ZEKA ANALÄ°ZÄ°
      </div>
      <button class="ai-panel-close" onclick="document.getElementById('ai-panel').classList.remove('show')">âœ•</button>
    </div>
    <div class="ai-panel-body">
      <div class="ai-panel-context" id="ai-panel-context">â€”</div>
      <div class="ai-panel-text" id="ai-panel-text">â€”</div>
    </div>
    <div class="ai-panel-footer">
      <div class="ai-model-tag">Claude Â· CanlÄ± Analiz</div>
      <button class="ai-refresh-btn" id="ai-refresh-btn" onclick="runAIAnalysis()">â†» Yenile</button>
    </div>
  </div>

  <div id="matchContainer">
    <div class="loading"><div class="spinner"></div><p>CanlÄ± maÃ§lar yÃ¼kleniyor...</p></div>
  </div>

  <div class="section-title" style="margin-top:40px">GENEL Ã–ZET</div>
  <div class="summary-grid">
    <div class="summary-card">
      <div class="big-num" style="color:var(--live)" id="totalGoals">â€”</div>
      <div class="label">Toplam Gol</div>
    </div>
    <div class="summary-card">
      <div class="big-num" style="color:var(--accent)" id="hotMatches">â€”</div>
      <div class="label">YÃ¼ksek Ä°htimalli MaÃ§</div>
    </div>
    <div class="summary-card">
      <div class="big-num" style="color:var(--accent3)" id="liveCount">â€”</div>
      <div class="label">CanlÄ± MaÃ§</div>
    </div>
  </div>

  <div class="api-note">âš¡ Veriler API-Football Ã¼zerinden Ã§ekiliyor Â· Otomatik yenileme: 30 saniye</div>

  <div class="info-panel">
    <div class="info-panel-title">ğŸ“– METRÄ°KLER HAKKINDA</div>
    <div class="info-grid">
      <div class="info-item">
        <div class="info-item-header">
          <span class="info-emoji">ğŸ¯</span>
          <span class="info-item-title">Sonraki Gol Ä°htimali</span>
        </div>
        <div class="info-item-desc">
          MaÃ§Ä±n geri kalanÄ±nda <strong>en az 1 gol atÄ±lma olasÄ±lÄ±ÄŸÄ±</strong>. xG hÄ±zÄ±, isabetli ÅŸut ve tehlikeli atak verileri birleÅŸtirilerek hesaplanÄ±r. Dakika ilerledikÃ§e baskÄ± artarsa yÃ¼kselir. <strong>%65+</strong> = yÃ¼ksek risk.
        </div>
      </div>
      <div class="info-item">
        <div class="info-item-header">
          <span class="info-emoji">ğŸ“Š</span>
          <span class="info-item-title">xG â€” Beklenen Gol</span>
        </div>
        <div class="info-item-desc">
          Her ÅŸutun <strong>pozisyonuna, aÃ§Ä±sÄ±na ve mesafesine</strong> gÃ¶re hesaplanan gol olasÄ±lÄ±ÄŸÄ±nÄ±n toplamÄ±. Ã–rnek: <strong>xG 2.4</strong> olan takÄ±m o maÃ§ta istatistiksel olarak 2-3 gol atmayÄ± hak ediyor demektir.
        </div>
      </div>
      <div class="info-item">
        <div class="info-item-header">
          <span class="info-emoji">âš¡</span>
          <span class="info-item-title">HÃ¼cum GÃ¼cÃ¼ BarÄ±</span>
        </div>
        <div class="info-item-desc">
          Ä°ki takÄ±mÄ±n <strong>toplam ofansif baskÄ±sÄ±nÄ±</strong> karÅŸÄ±laÅŸtÄ±rÄ±r. xG, isabetli ÅŸut, tehlikeli atak ve top kontrolÃ¼ aÄŸÄ±rlÄ±klÄ± hesaplanÄ±r. BarÄ±n aÄŸÄ±r bastÄ±ÄŸÄ± taraf <strong>gol iÃ§in daha elveriÅŸli</strong> konumda.
        </div>
      </div>
      <div class="info-item">
        <div class="info-item-header">
          <span class="info-emoji">ğŸ”¥</span>
          <span class="info-item-title">BaskÄ± Yapan Rozeti</span>
        </div>
        <div class="info-item-desc">
          Bir takÄ±mÄ±n tehlikeli atak ve isabetli ÅŸut sayÄ±sÄ± rakibine gÃ¶re <strong>belirgin ÅŸekilde yÃ¼ksek</strong> olduÄŸunda gÃ¶rÃ¼nÃ¼r. Gol gelmese bile o takÄ±mÄ±n <strong>anlÄ±k Ã¼stÃ¼nlÃ¼ÄŸÃ¼nÃ¼</strong> ifade eder.
        </div>
      </div>
    </div>
  </div>
</main>

<script>
// â”€â”€ CACHE SUNUCUSU AYARI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Sunucunun IP veya domain'ini buraya yaz
// Ã–rn: 'http://123.456.78.90:3001' veya 'http://tahminci.com:3001'
const CACHE_SERVER = window.location.origin; // AynÄ± sunucudan Ã§alÄ±ÅŸÄ±yor

// Eski direkt API ayarlarÄ± (artÄ±k kullanÄ±lmÄ±yor â€” sadece yedek)
const API_KEY = 'f3ccf91cf086e59284f51f352ca37f1d';
const BASE    = 'https://v3.football.api-sports.io';

// Cache sunucusundan tÃ¼m veriyi tek seferde Ã§ek
let _cacheData = null;
async function fetchCacheServer() {
  try {
    const r = await fetch(CACHE_SERVER + '/live', { cache: 'no-store' });
    if (!r.ok) throw new Error('Cache sunucu ' + r.status);
    _cacheData = await r.json();
    return _cacheData;
  } catch(e) {
    console.warn('Cache sunucuya eriÅŸilemedi, direkt API deneniyor:', e.message);
    return null;
  }
}

async function fetchAPI(path) {
  const r = await fetch(BASE + path, { headers: { 'x-apisports-key': API_KEY } });
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  const d = await r.json();
  if (d.errors && Object.keys(d.errors).length) throw new Error(JSON.stringify(d.errors));
  return d;
}

// Events verisinden korner/kart Ã§Ä±kar
// API-Football event format:
//   type: "Goal" | "Card" | "subst" | "Var"
//   detail: "Normal Goal" | "Corner" | "Yellow Card" | "Red Card" | "Second Yellow card" | ...
//   comments: "Corner" (korner goldeki gibi bazÄ± durumlarda)
function extractFromEvents(eventsArr, teamId) {
  const out = { corners:0, yellow_cards:0, red_cards:0 };
  if (!eventsArr || !eventsArr.length) return out;
  eventsArr.forEach(ev => {
    if (ev.team?.id !== teamId) return;
    const type   = (ev.type   || '').toLowerCase().trim();
    const detail = (ev.detail || '').toLowerCase().trim();

    // KORNER: API-Football'da "Corner" ayrÄ± bir event type'Ä± OLARAK gelmez
    // GerÃ§ek kÃ¶ÅŸe vuruÅŸlarÄ± ÅŸu ÅŸekilde gelir:
    //   type: "Goal", detail: "Normal Goal", comments: "Corner kick"
    //   VEYA type: "Goal", detail: "Corner"  
    // Not: cornerler Ã§oÄŸunlukla statistics endpoint'inden gelir (Corner Kicks)
    if (type === 'goal' && (detail === 'corner' || (ev.comments || '').toLowerCase().includes('corner'))) {
      out.corners++; // Bu kornerden gelen goldÃ¼r, direct corner count deÄŸil
    }

    // KART
    if (type === 'card') {
      if (detail.includes('yellow') && !detail.includes('second')) out.yellow_cards++;
      if (detail.includes('red') || detail.includes('second yellow')) out.red_cards++;
    }
  });
  return out;
}

// Statistics'ten corner sayÄ±sÄ±nÄ± doÄŸrudan Ã§ek (en gÃ¼venilir yol)
function extractCornersFromStats(statsArr, teamId) {
  if (!statsArr || !statsArr.length) return null;
  const side = statsArr.find(s => s.team?.id === teamId);
  if (!side) return null;
  for (const st of (side.statistics || [])) {
    const t = (st.type || '').toLowerCase();
    if (t.includes('corner')) {
      const v = parseInt(st.value);
      return isNaN(v) ? null : v;
    }
  }
  return null;
}

function extractStats(statsArr, teamId, fallbackGoals, minute, eventsArr) {
  const obj = {
    xg: null, shots_on: null, shots_total: null, dangerous_attacks: null,
    ball_possession: null, corners: null, yellow_cards: null,
    red_cards: null, fouls: null, offsides: null,
    hasRealData: false
  };

  // 1. Events'ten kart verisini Ã§ek (en gÃ¼venilir kart kaynaÄŸÄ±)
  if (eventsArr && eventsArr.length) {
    const evData = extractFromEvents(eventsArr, teamId);
    obj.yellow_cards = evData.yellow_cards;
    obj.red_cards    = evData.red_cards;
    // Korner events'ten de geliyorsa al
    if (evData.corners > 0) obj.corners = evData.corners;
  }

  // 2. Statistics endpoint verisini parse et
  if (statsArr && statsArr.length) {
    const side = statsArr.find(s => s.team?.id === teamId);
    if (side && side.statistics?.length) {
      side.statistics.forEach(st => {
        const raw = st.value;
        if (raw === null || raw === undefined || raw === '') return;
        const v = raw;
        const t = (st.type || '').toLowerCase();

        if (t.includes('possession')) {
          const pv = parseInt(v);
          if (!isNaN(pv)) obj.ball_possession = pv;
        }
        if (t.includes('shots on goal') || t.includes('shots on target')) {
          const sv = parseInt(v);
          if (!isNaN(sv)) obj.shots_on = sv;
        }
        if (t.includes('total shots')) {
          const sv = parseInt(v);
          if (!isNaN(sv)) obj.shots_total = sv;
        }
        if (t.includes('dangerous attack')) {
          const dv = parseInt(v);
          if (!isNaN(dv)) obj.dangerous_attacks = dv;
        }
        if (t.includes('expected_goals') || t === 'expected goals' || t.includes('xg')) {
          const xv = parseFloat(v);
          if (!isNaN(xv)) obj.xg = xv;
        }
        if (t.includes('corner')) {
          const cv = parseInt(v);
          if (!isNaN(cv)) obj.corners = Math.max(obj.corners || 0, cv);
        }
        if (t.includes('yellow card')) {
          const yv = parseInt(v);
          if (!isNaN(yv)) obj.yellow_cards = Math.max(obj.yellow_cards || 0, yv);
        }
        if (t.includes('red card')) {
          const rv = parseInt(v);
          if (!isNaN(rv)) obj.red_cards = Math.max(obj.red_cards || 0, rv);
        }
        if (t.includes('fouls')) {
          const fv = parseInt(v);
          if (!isNaN(fv)) obj.fouls = fv;
        }
        if (t.includes('offside')) {
          const ov = parseInt(v);
          if (!isNaN(ov)) obj.offsides = ov;
        }
      });

      // GerÃ§ek veri var mÄ± kontrol et
      obj.hasRealData = (
        obj.shots_on !== null ||
        obj.dangerous_attacks !== null ||
        obj.xg !== null
      );
    }
  }

  // 3. null deÄŸerleri 0'a Ã§evir â€” ama hasRealData false ise analiz yapma
  obj.xg               = obj.xg               ?? 0;
  obj.shots_on         = obj.shots_on         ?? 0;
  obj.shots_total      = obj.shots_total      ?? 0;
  obj.dangerous_attacks= obj.dangerous_attacks?? 0;
  obj.ball_possession  = obj.ball_possession  ?? 50;
  obj.corners          = obj.corners          ?? 0;
  obj.yellow_cards     = obj.yellow_cards     ?? 0;
  obj.red_cards        = obj.red_cards        ?? 0;
  obj.fouls            = obj.fouls            ?? 0;
  obj.offsides         = obj.offsides         ?? 0;

  return obj;
}

function calcGoalProb(h, a) {
  if (!h.hasRealData && !a.hasRealData) return { home: 50, away: 50, noData: true };
  const hS = h.xg*0.5 + h.shots_on*0.12 + h.dangerous_attacks*0.06 + h.ball_possession*0.004;
  const aS = a.xg*0.5 + a.shots_on*0.12 + a.dangerous_attacks*0.06 + a.ball_possession*0.004;
  const total = (hS + aS) || 1;
  const hp = Math.round((hS / total) * 100);
  return { home: hp, away: 100 - hp, noData: false };
}

function calcNextGoalProb(h, a, minute) {
  if (!h.hasRealData && !a.hasRealData) return 0; // veri yoksa 0 dÃ¶ndÃ¼r
  const min = parseInt(minute) || 45;
  const xgTotal = h.xg + a.xg;
  const rate = xgTotal / Math.max(min, 1);
  const factor = min > 75 ? 1.4 : min > 60 ? 1.2 : min > 45 ? 1.1 : 1.0;
  return Math.min(95, Math.max(5, Math.round(rate * 30 * factor * 100)));
}

function generateInsight(hS, aS, homeTeam, awayTeam, minute, nextGoalProb, homeGoals, awayGoals, fixtureId) {
  if (!hS.hasRealData && !aS.hasRealData) {
    return `<div class="match-insight level-low">
      <div class="insight-header"><span class="insight-header-icon">â³</span>Ä°STATÄ°STÄ°K BEKLENÄ°YOR</div>
      <div class="insight-content"><div class="bet-reason">Veriler API'den henÃ¼z gelmedi, otomatik gÃ¼ncelleniyor...</div></div>
    </div>`;
  }

  const min          = parseInt(minute) || 45;
  const hG           = homeGoals || 0;
  const aG           = awayGoals || 0;
  const totalGoals   = hG + aG;
  const hXg          = +hS.xg.toFixed(2);
  const aXg          = +aS.xg.toFixed(2);
  const totalXg      = +(hXg + aXg).toFixed(2);
  const totalShots   = hS.shots_on + aS.shots_on;
  const totalAtk     = hS.dangerous_attacks + aS.dangerous_attacks;
  const totalCorners = hS.corners + aS.corners;
  const hCorners     = hS.corners;
  const aCorners     = aS.corners;
  const totalYellow  = hS.yellow_cards + aS.yellow_cards;
  const totalRed     = hS.red_cards + aS.red_cards;
  const totalFouls   = hS.fouls + aS.fouls;
  const scoreDiff    = Math.abs(hG - aG);
  const losingTeam   = hG < aG ? homeTeam : hG > aG ? awayTeam : null;
  const leadingTeam  = hG > aG ? homeTeam : hG < aG ? awayTeam : null;
  const losingXg     = hG < aG ? hXg : aXg;
  const losingShots  = hG < aG ? hS.shots_on : aS.shots_on;
  const losingAtk    = hG < aG ? hS.dangerous_attacks : aS.dangerous_attacks;
  const remainMin    = Math.max(90 - min, 1);
  const xgPace10     = +(totalXg / Math.max(min,1) * 10).toFixed(2);
  const cornerPer90  = +(totalCorners / Math.max(min,1) * 90).toFixed(1);
  const cornerLeft   = +(totalCorners / Math.max(min,1) * remainMin).toFixed(1);
  const projCorners  = +(totalCorners + cornerLeft).toFixed(1);

  const hPress = hS.dangerous_attacks*1.2 + hS.shots_on*2.5 + hXg*9;
  const aPress = aS.dangerous_attacks*1.2 + aS.shots_on*2.5 + aXg*9;
  const pressTeam  = hPress > aPress*1.25 ? homeTeam : aPress > hPress*1.25 ? awayTeam : null;
  const pressXg    = pressTeam===homeTeam ? hXg : aXg;
  const pressShots = pressTeam===homeTeam ? hS.shots_on : aS.shots_on;
  const pressAtk   = pressTeam===homeTeam ? hS.dangerous_attacks : aS.dangerous_attacks;

  // Dakika segmentleri
  const isOver     = min > 85;   // 85+ dakika = bahis kutusu bile gÃ¶sterme
  const isCritical = min > 80;   // 80-85: sadece Ã§ok gÃ¼Ã§lÃ¼ sinyal
  const isVeryLate = min > 72;   // 72-80: eÅŸikler yÃ¼kselir
  const isLate     = min > 60;   // 60-72: dikkatli

  const minProbGoal  = isOver?999: isCritical?82: isVeryLate?76: isLate?68: 62;
  const minXgGoal    = isOver?999: isCritical?2.2: isVeryLate?1.8: isLate?1.4: 1.0;
  const minShotsGoal = isOver?999: isCritical?7:   isVeryLate?5:   isLate?4:   3;
  const minRemGoal   = isOver?999: isCritical?8:   isVeryLate?12:  isLate?15:  15;

  const golVar      = !isOver && nextGoalProb>=minProbGoal && totalXg>=minXgGoal && totalShots>=minShotsGoal && remainMin>=minRemGoal;
  const golVarGuclu = !isOver && nextGoalProb>=(minProbGoal+7) && totalXg>=(minXgGoal+0.3) && totalShots>=(minShotsGoal+1) && remainMin>=minRemGoal;
  const golYok      = !isOver && nextGoalProb<=30 && totalXg<=0.6 && totalShots<=2 && remainMin>=20;

  const over05 = totalGoals>=1, over15=totalGoals>=2, over25=totalGoals>=3, over35=totalGoals>=4;
  const minRemUst = isOver?999: isCritical?10: isVeryLate?15: 15;
  const next15 = !over15 && xgPace10>=(isVeryLate?0.7:0.35) && remainMin>=minRemUst && nextGoalProb>=minProbGoal;
  const next25 = !over25 && xgPace10>=(isVeryLate?0.8:0.45) && remainMin>=minRemUst && nextGoalProb>=minProbGoal;
  const next35 = !over35 && over25 && xgPace10>=0.55 && remainMin>=(isCritical?12:15) && nextGoalProb>=65;

  const minXgKg  = isCritical?1.2: isVeryLate?0.9: isLate?0.7: 0.5;
  const minAtkKg = isCritical?16:  isVeryLate?13:  isLate?10:  6;
  const kgGuclu  = !isOver && scoreDiff>=1 && losingXg>=minXgKg && losingAtk>=minAtkKg && losingShots>=2 && remainMin>=minRemGoal;
  const kgOrta   = !isOver && !isCritical && scoreDiff>=1 && losingXg>=0.5 && losingAtk>=6 && remainMin>=20;

  const cornerLines = [8.5,9.5,10.5,11.5,12.5];
  const bestCornerLine    = remainMin>=8 ? (cornerLines.slice().reverse().find(l=>projCorners>l+0.8)||null) : null;
  const cornerAlreadyOver = cornerLines.slice().reverse().find(l=>totalCorners>l) || null;
  const cornerDomTeam     = hCorners>=aCorners+3?homeTeam: aCorners>=hCorners+3?awayTeam: null;

  const cardLines    = [3.5, 4.5, 5.5, 6.5, 7.5];  // Daha geniÅŸ eÅŸik aralÄ±ÄŸÄ±
  const currentCards = totalYellow + totalRed * 2;   // KÄ±rmÄ±zÄ± 2 kart sayÄ±lÄ±r
  // DÃœZELTME: >= kullan (6 kart 5.5 eÅŸiÄŸini geÃ§meli)
  const bestCardLine = cardLines.slice().reverse().find(l => currentCards >= l + 0.5) || null;
  const cardProjLine = (() => {
    if (min < 10 || remainMin < 10) return null;
    const proj = +(currentCards / Math.max(min, 1) * 90).toFixed(1);
    return cardLines.slice().reverse().find(l => proj >= l + 0.5) || null;
  })();
  const sertMac = totalFouls >= 14 || totalYellow >= 3 || totalRed >= 1;
  const aggressiveTeam = hS.fouls > aS.fouls + 3 ? homeTeam : aS.fouls > hS.fouls + 3 ? awayTeam : null;

  // â”€â”€ KUTU ÃœRETÄ°CÄ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function box(level, headerIcon, headerLabel, betCall, reason, tags) {
    return `
    <div class="match-insight level-${level}">
      <div class="insight-header">
        <span class="insight-header-icon">${headerIcon}</span>
        ${headerLabel}
      </div>
      <div class="insight-content">
        <div class="bet-call">${betCall}</div>
        <div class="bet-reason">${reason}</div>
        <div class="insight-tags">${tags.filter(Boolean).map(t=>`<span class="insight-tag">${t}</span>`).join('')}</div>
      </div>
    </div>`;
  }

  let boxes = '';
  // Sinyal skoru â€” en iyi sinyali bulmak iÃ§in
  let bestScore = 0, bestSignal = null;

  function trySignal(score, label, match, why, type, fid) {
    // â”€â”€ Dakika filtresi: bitime yakÄ±n maÃ§lara sinyal verme â”€â”€
    const minRemainRequired = {
      gol:    20,   // Gol bahsi: en az 20dk kalmÄ±ÅŸ olmalÄ±
      kg:     15,   // KG Var: en az 15dk
      korner: 12,   // Korner: en az 12dk (projeksiyon anlamlÄ±)
      kart:    8,   // Kart: en az 8dk (kÄ±rmÄ±zÄ± kart ani etki)
    }[type || 'gol'] || 20;

    if (remainMin < minRemainRequired) return; // SÃ¼re yetersiz â€” sinyal verme
    if (min > 85) return;                       // 85+ dakika â€” kesinlikle verme

    if (score > bestScore) {
      bestScore  = score;
      bestSignal = { label, match, why, type: type||'gol', minute: min, fixtureId: fid||null };
    }
  }

  // â”€â”€ MAÃ‡ BÄ°TÄ°YOR â”€â”€
  if (isOver) {
    return box('low','ğŸ','MAÃ‡ BÄ°TÄ°YOR',
      'Bahis penceresi kapandÄ±',
      `${min}. dakika geÃ§ildi. Kalan ${remainMin} dakikada yeni bahis aÃ§mak mantÄ±klÄ± deÄŸil.`,
      [`${min}. Dakika`,`${remainMin}dk KaldÄ±`]);
  }

  // â”€â”€ 1. GOL BAHSÄ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (golVarGuclu && next25) {
    const call = `2.5 Ãœst â€” OynayÄ±n`;
    const why = `${totalGoals} gol oldu, tempo dÃ¼ÅŸmÃ¼yor. xG ${totalXg}, ${totalShots} kaleye ÅŸut, ${totalAtk} tehlikeli atak. ${pressTeam?pressTeam+' baskÄ±da.':''} ÃœÃ§Ã¼ncÃ¼ gol Ã§ok yakÄ±n.`;
    boxes += box('hot','âš½','GOL BAHSÄ°', call, why, ['âœ… 2.5 ÃœST',`xG ${totalXg}`,`${totalShots} Åut`,`${remainMin}dk`]);
    trySignal(95, `2.5 Ãœst OynayÄ±n`, `${homeTeam} - ${awayTeam}`, why, 'gol', fixtureId);

  } else if (golVarGuclu && next15) {
    const call = `1.5 Ãœst â€” OynayÄ±n`;
    const why = `MaÃ§ Ã§ok aÃ§Ä±k oynanÄ±yor. xG ${totalXg}, ${totalShots} kaleye ÅŸut. ${pressTeam?pressTeam+' kaleyi zorluyor.':''} Bir gol daha kesinlikle bekliyorum.`;
    boxes += box('hot','âš½','GOL BAHSÄ°', call, why, ['âœ… 1.5 ÃœST',`xG ${totalXg}`,`${totalShots} Åut`,`${remainMin}dk`]);
    trySignal(90, `1.5 Ãœst OynayÄ±n`, `${homeTeam} - ${awayTeam}`, why, 'gol', fixtureId);

  } else if (golVarGuclu) {
    const call = `Bir Gol Daha Gelir â€” Gol Var`;
    const why = pressTeam
      ? `${pressTeam} tam baskÄ±da: xG ${pressXg}, ${pressShots} isabetli ÅŸut, ${pressAtk} tehlikeli atak. Gol an meselesi.`
      : `xG ${totalXg} ve ${totalShots} kaleye ÅŸut Ã§ok yÃ¼ksek. Her iki taraf da gol pozisyonuna giriyor.`;
    boxes += box('hot','âš½','GOL BAHSÄ°', call, why, ['âœ… GOL VAR',`xG ${totalXg}`,`${totalShots} Åut`,`${remainMin}dk`]);
    trySignal(85, `Gol Var OynayÄ±n`, `${homeTeam} - ${awayTeam}`, why, 'gol', fixtureId);

  } else if (golVar && next25) {
    const call = `2.5 Ãœst â€” OynayÄ±n`;
    const why = `${totalGoals} gol var, xG hÄ±zÄ± ${xgPace10}/10dk. Tempo gol iÃ§in uygun, bir gol daha bekliyorum.`;
    boxes += box('warm','âš½','GOL BAHSÄ°', call, why, ['âš¡ 2.5 ÃœST',`xG HÄ±zÄ± ${xgPace10}/10dk`,`${totalGoals} Gol`,`${remainMin}dk`]);
    trySignal(75, `2.5 Ãœst OynayÄ±n`, `${homeTeam} - ${awayTeam}`, why, 'gol', fixtureId);

  } else if (golVar && next15) {
    const call = `1.5 Ãœst â€” OynayÄ±n`;
    const why = `${totalGoals} gol geldi. xG ${totalXg}, ${totalShots} ÅŸut ile tempo devam ediyor. Bir gol daha normal.`;
    boxes += box('warm','âš½','GOL BAHSÄ°', call, why, ['âš¡ 1.5 ÃœST',`xG ${totalXg}`,`${remainMin}dk`]);
    trySignal(70, `1.5 Ãœst OynayÄ±n`, `${homeTeam} - ${awayTeam}`, why, 'gol', fixtureId);

  } else if (golVar) {
    const call = `Gol Var â€” OynayÄ±n`;
    const why = `xG ${totalXg}, ${totalShots} kaleye ÅŸut. Sinyal yeterince gÃ¼Ã§lÃ¼, gol oynayÄ±n.`;
    boxes += box('warm','âš½','GOL BAHSÄ°', call, why, ['âš¡ GOL VAR',`xG ${totalXg}`,`${min}. Dk`]);
    trySignal(60, `Gol Var OynayÄ±n`, `${homeTeam} - ${awayTeam}`, why, 'gol', fixtureId);

  } else if (next35 && over25) {
    const call = `3.5 Ãœst â€” OynayÄ±n`;
    const why = `3 gol geldi, xG hÄ±zÄ± ${xgPace10}/10dk ile tempo devam ediyor. DÃ¶rdÃ¼ncÃ¼ gol iÃ§in ÅŸans var.`;
    boxes += box('hot','âš½','GOL BAHSÄ°', call, why, ['âš¡ 3.5 ÃœST',`${totalGoals} Gol`,`xG HÄ±zÄ± ${xgPace10}/10dk`]);
    trySignal(80, `3.5 Ãœst OynayÄ±n`, `${homeTeam} - ${awayTeam}`, why, 'gol', fixtureId);

  } else if (over35) {
    boxes += box('calm','âœ…','GOL BAHSÄ°',
      `3.5 Ãœst Dolu â€” Tebrikler`,
      `${totalGoals} gol atÄ±ldÄ±. 1.5, 2.5 ve 3.5 Ãœst hepsi dolu. ${xgPace10>=0.5?`xG hÄ±zÄ± ${xgPace10}/10dk â€” 4.5 Ãœst aÃ§Ä±ksa bakÄ±n.`:''}`,
      ['âœ… 3.5 DOLU','âœ… 2.5 DOLU','âœ… 1.5 DOLU',xgPace10>=0.5?'4.5 Ãœst?':'']);

  } else if (over25) {
    boxes += box('calm','âœ…','GOL BAHSÄ°',
      `2.5 Ãœst Dolu`,
      `${totalGoals} gol atÄ±ldÄ±. 1.5 ve 2.5 Ãœst dolu. ${next35?`xG hÄ±zÄ± ${xgPace10}/10dk ile 3.5 Ãœst iÃ§in oynayÄ±n.`:`3.5 Ãœst iÃ§in tempo yavaÅŸ (${xgPace10}/10dk).`}`,
      ['âœ… 2.5 DOLU','âœ… 1.5 DOLU',next35?'âš¡ 3.5 Ãœst AÃ§':'']);

  } else if (over15) {
    boxes += box('calm','âœ…','GOL BAHSÄ°',
      `1.5 Ãœst Dolu`,
      `${totalGoals} gol atÄ±ldÄ±. ${next25?`xG hÄ±zÄ± ${xgPace10}/10dk iyi, 2.5 Ãœst iÃ§in hÃ¢lÃ¢ oynayÄ±n.`:`2.5 Ãœst iÃ§in tempo yavaÅŸ (${xgPace10}/10dk) â€” bekleyin.`}`,
      ['âœ… 1.5 DOLU',next25?'âš¡ 2.5 Ãœst AÃ§':'âŒ 2.5 Ãœst ZayÄ±f']);

  } else if (golYok) {
    const call = `Alt â€” Gol Yok`;
    const why = `${min}. dakika, xG sadece ${totalXg} ve ${totalShots} kaleye ÅŸut. Ä°ki takÄ±m da pozisyon Ã¼retemiyor. Alt oynayÄ±n.`;
    boxes += box('low','ğŸ§Š','GOL BAHSÄ°', call, why, ['âœ… ALT / GOL YOK',`xG ${totalXg}`,`${min}. Dk`]);
    trySignal(55, `Alt (Gol Yok) OynayÄ±n`, `${homeTeam} - ${awayTeam}`, why, 'gol', fixtureId);

  } else {
    boxes += box('low','ğŸ“Š','GOL BAHSÄ°',
      `Sinyal Yok â€” Bekleyin`,
      `xG ${totalXg}, ${totalShots} ÅŸut. Åu an net bir bahis fÄ±rsatÄ± gÃ¶remiyorum. MaÃ§Ä± izlemeye devam edin.`,
      ['â¸ Bekle',`xG ${totalXg}`,`${min}. Dk`]);
  }

  // â”€â”€ 2. KG VAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (totalGoals>=1 && remainMin>=10) {
    if (kgGuclu) {
      const call = `KG Var â€” OynayÄ±n`;
      const why = `${losingTeam} geride ama maÃ§ta aktif: xG ${losingXg}, ${losingAtk} tehlikeli atak, ${losingShots} kaleye ÅŸut. EÅŸitleme golÃ¼ iÃ§in her ÅŸeyi veriyor, ${remainMin} dakika var.`;
      boxes += box(remainMin<=20?'hot':'warm','ğŸ”µ','KG VAR / BÄ°R GOL DAHA', call, why,
        ['âœ… KG VAR',`${losingTeam} xG ${losingXg}`,`${losingAtk} Teh.Atak`,`${remainMin}dk`]);
      trySignal(remainMin<=20?88:72, `KG Var OynayÄ±n`, `${homeTeam} - ${awayTeam}`, why, 'kg', fixtureId);

    } else if (kgOrta) {
      const call = `KG Var â€” OynayÄ±n`;
      const why = `${losingTeam} geride ve pozisyon Ã¼retiyor (xG ${losingXg}). ${remainMin} dakika var, eÅŸitleme mÃ¼mkÃ¼n.`;
      boxes += box('warm','ğŸ”µ','KG VAR', call, why,
        ['âš¡ KG VAR',`${losingTeam} xG ${losingXg}`,`${remainMin}dk`]);
      trySignal(62, `KG Var OynayÄ±n`, `${homeTeam} - ${awayTeam}`, why, 'gol', fixtureId);

    } else if (scoreDiff>=2 && min>=70) {
      boxes += box('low','ğŸ”µ','KG VAR',
        `KG Var OynamayÄ±n`,
        `${leadingTeam} ${scoreDiff} golle Ã¶nde, ${remainMin} dakika kaldÄ±. Geride kalan takÄ±mÄ±n xG ve baskÄ±sÄ± geri dÃ¶nÃ¼ÅŸe yetmez.`,
        ['âŒ KG VAR ZOR',`${scoreDiff} Gol Fark`,`${remainMin}dk`]);

    } else if (scoreDiff===0 && totalGoals>=1) {
      boxes += box('calm','ğŸ”µ','KG VAR / SKOR',
        `Sonraki Gol Belirleyici`,
        `Berabere, KG Var zaten aktif. ${pressTeam?pressTeam+' ÅŸu an daha baskÄ±lÄ± â€” bir sonraki gol ondan gelebilir.':'Sonraki golÃ¼ kimin atacaÄŸÄ± belirsiz.'} MaÃ§Ä± izleyin.`,
        ['ğŸ¤ Berabere',pressTeam||'Dengeli',`${remainMin}dk`]);
    }
  }

  // â”€â”€ 3. KORNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (totalCorners>=3 || cornerAlreadyOver || bestCornerLine) {
    if (cornerAlreadyOver) {
      const nextLine = cornerLines.find(l=>l>cornerAlreadyOver);
      const nextOpen = nextLine && projCorners>nextLine+0.5 && remainMin>=8;
      if (nextOpen) {
        const call = `${nextLine} Ãœst Korner â€” OynayÄ±n`;
        const why = `Åu an ${totalCorners} korner var, ${cornerAlreadyOver} Ãœst dolu. Kalan sÃ¼reyle projeksiyon ${projCorners} â€” bir sonraki eÅŸiÄŸi de geÃ§er.${cornerDomTeam?` ${cornerDomTeam} ${Math.max(hCorners,aCorners)}-${Math.min(hCorners,aCorners)} Ã¶nde.`:''}`;
        boxes += box('hot','ğŸš©','KORNER BAHSÄ°', call, why,
          [`âœ… ${cornerAlreadyOver} Ãœst Dolu`,`âš¡ ${nextLine} Ãœst AÃ§`,`Proj: ${projCorners}`,`${remainMin}dk`]);
        trySignal(82, `${nextLine} Ãœst Korner OynayÄ±n`, `${homeTeam} - ${awayTeam}`, why, 'gol', fixtureId);
      } else {
        const nextLineLabel = nextLine ? ` ${nextLine} Ãœst iÃ§in projeksiyon yetmez (${projCorners}).` : '';
        boxes += box('calm','ğŸš©','KORNER BAHSÄ°',
          `${cornerAlreadyOver} Ãœst Dolu`,
          `${totalCorners} korner kullanÄ±ldÄ±.${nextLineLabel}${cornerDomTeam?` ${cornerDomTeam} ${Math.max(hCorners,aCorners)}-${Math.min(hCorners,aCorners)} Ã¶nde.`:''}`,
          [`âœ… ${cornerAlreadyOver} Ãœst Dolu`,nextLine?`âŒ ${nextLine} ZayÄ±f`:'',`${totalCorners} Korner`]);
      }
    } else if (bestCornerLine && remainMin>=12) {
      const call = `${bestCornerLine} Ãœst Korner â€” OynayÄ±n`;
      const why = `Åu an ${totalCorners} korner kullanÄ±ldÄ±. Kalan ${remainMin} dakikayla birlikte projeksiyon ${projCorners} â€” ${bestCornerLine} eÅŸiÄŸini rahatÃ§a geÃ§er.${cornerDomTeam?` ${cornerDomTeam} ${Math.max(hCorners,aCorners)}-${Math.min(hCorners,aCorners)} Ã¶nde.`:''}`;
      boxes += box('warm','ğŸš©','KORNER BAHSÄ°', call, why,
        [`âš¡ ${bestCornerLine} Ãœst`,`Proj: ${projCorners}`,`${totalCorners} Korner`,`${remainMin}dk`]);
      trySignal(68, `${bestCornerLine} Ãœst Korner OynayÄ±n`, `${homeTeam} - ${awayTeam}`, why, 'gol', fixtureId);
    } else if (cornerDomTeam && totalCorners>=3) {
      const call = `${cornerDomTeam} Korner HandikapÄ± â€” OynayÄ±n`;
      const why = `${cornerDomTeam} ${Math.max(hCorners,aCorners)}-${Math.min(hCorners,aCorners)} kornerde bÃ¼yÃ¼k Ã¶nde. Bu Ã¼stÃ¼nlÃ¼k maÃ§ boyunca devam ederse handikap deÄŸerli.`;
      boxes += box('calm','ğŸš©','KORNER BAHSÄ°', call, why,
        ['âš¡ Korner Handikap',cornerDomTeam,`${Math.max(hCorners,aCorners)}-${Math.min(hCorners,aCorners)}`]);
      trySignal(55, `${cornerDomTeam} Korner HandikapÄ±`, `${homeTeam} - ${awayTeam}`, why, 'gol', fixtureId);
    }
  }

  // â”€â”€ 4. KART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (sertMac || bestCardLine || cardProjLine) {
    if (totalRed>=1) {
      const redTeam = hS.red_cards>0?homeTeam:awayTeam;
      const call = bestCardLine ? `${bestCardLine} Ãœst Kart â€” OynayÄ±n` : `Kart Var â€” OynayÄ±n`;
      const nextCardLine = bestCardLine ? cardLines.find(l=>l>bestCardLine) : cardLines[0];
      const why = `${redTeam} kÄ±rmÄ±zÄ± kart gÃ¶rdÃ¼ ve 10 kiÅŸi kaldÄ±. 10 kiÅŸilik takÄ±m Ã§aresiz faullar yapacak â€” ek kart kaÃ§Ä±nÄ±lmaz. ${nextCardLine?`${nextCardLine} Ãœst iÃ§in de bakÄ±n.`:''}`;
      boxes += box('hot','ğŸŸ¥','KART BAHSÄ°', call, why,
        [bestCardLine?`âœ… ${bestCardLine} Ãœst Dolu`:'',`âš¡ Ek Kart Gelir`,`${redTeam} 10 KiÅŸi`,`${totalYellow} SarÄ±`]);
      trySignal(86, call, `${homeTeam} - ${awayTeam}`, why, 'kart');

    } else if (bestCardLine) {
      const nextLine = cardLines.find(l=>l>bestCardLine);
      const nextOpen = nextLine && cardProjLine>=nextLine;
      const call = nextOpen ? `${nextLine} Ãœst Kart â€” OynayÄ±n` : `${bestCardLine} Ãœst Dolu`;
      const why = `${currentCards} kart gÃ¶rÃ¼ldÃ¼, ${bestCardLine} Ãœst dolu.${nextOpen?` Projeksiyon ${nextLine} eÅŸiÄŸini geÃ§iyor â€” ${nextLine} Ãœst oynayÄ±n.`:''}${aggressiveTeam?` ${aggressiveTeam} Ã§ok agresif oynuyor.`:''}`;
      boxes += box(nextOpen?'hot':'calm','ğŸŸ¨','KART BAHSÄ°', call, why,
        [`âœ… ${bestCardLine} Ãœst Dolu`,nextOpen?`âš¡ ${nextLine} Ãœst AÃ§`:'',`${totalYellow} SarÄ±`,totalFouls?`${totalFouls} Faul`:'']);
      if (nextOpen) trySignal(76, `${nextLine} Ãœst Kart OynayÄ±n`, `${homeTeam} - ${awayTeam}`, why, 'kart', fixtureId);

    } else if (cardProjLine) {
      const call = `${cardProjLine} Ãœst Kart â€” OynayÄ±n`;
      const why = `${totalYellow} sarÄ± kart${totalFouls?`, ${totalFouls} faul`:''} var. Bu tempo devam ederse projeksiyon ${cardProjLine} eÅŸiÄŸini geÃ§iyor.${aggressiveTeam?` ${aggressiveTeam} Ã¶zellikle agresif.`:''}`;
      boxes += box('warm','ğŸŸ¨','KART BAHSÄ°', call, why,
        [`âš¡ ${cardProjLine} Ãœst`,`${totalYellow} SarÄ±`,aggressiveTeam||'',totalFouls?`${totalFouls} Faul`:'']);
      trySignal(64, `${cardProjLine} Ãœst Kart OynayÄ±n`, `${homeTeam} - ${awayTeam}`, why, 'kart', fixtureId);

    } else if (sertMac && remainMin>=20) {
      const call = `3.5 Ãœst Kart â€” OynayÄ±n`;
      const why = `Sert bir maÃ§ gidiyor: ${totalYellow} sarÄ± kart${totalFouls?`, ${totalFouls} faul`:''}.${aggressiveTeam?` ${aggressiveTeam} Ã§ok faul yapÄ±yor.`:''} Bu tempo devam ederse daha fazla kart kaÃ§Ä±nÄ±lmaz.`;
      boxes += box('warm','ğŸŸ¨','KART BAHSÄ°', call, why,
        ['âš¡ 3.5 Ãœst Kart',`${totalYellow} SarÄ±`,aggressiveTeam||'Sert Tempo',`${remainMin}dk`]);
      trySignal(58, `3.5 Ãœst Kart OynayÄ±n`, `${homeTeam} - ${awayTeam}`, why, 'kart', fixtureId);
    }
  }

  // bestSignal'i global store'a kaydet
  if (bestSignal) {
    window._signals = window._signals || [];
    // minute zaten bestSignal iÃ§inde (trySignal'den geliyor)
    window._signals.push({ score: bestScore, ...bestSignal });
  }

  return boxes || box('low','ğŸ“Š','ANALÄ°Z',
    'Bekleyin',
    `xG ${totalXg}, ${totalShots} ÅŸut. Åu an net bir bahis sinyali yok.`,
    ['â¸ Bekle',`xG ${totalXg}`,`${min}. Dk`]);
}

function getProbTag(p) {
  if (p >= 65) return '<span class="tag tag-high">YÃœKSEK</span>';
  if (p >= 40) return '<span class="tag tag-mid">ORTA</span>';
  return '<span class="tag tag-low">DÃœÅÃœK</span>';
}

function renderMatch(fixture, statsArr, idx, eventsArr) {
  const { teams, goals, fixture: fx, league } = fixture;
  const minute   = fx?.status?.elapsed || '?';
  const statusSh = fx?.status?.short || '';
  const isHT     = statusSh === 'HT';

  const hS = extractStats(statsArr, teams.home.id, goals.home, minute, eventsArr);
  const aS = extractStats(statsArr, teams.away.id, goals.away, minute, eventsArr);
  const prob     = calcGoalProb(hS, aS);
  const nextGoal = calcNextGoalProb(hS, aS, minute);

  const hotHome = hS.dangerous_attacks > aS.dangerous_attacks * 1.4 && hS.shots_on > aS.shots_on;
  const hotAway = aS.dangerous_attacks > hS.dangerous_attacks * 1.4 && aS.shots_on > hS.shots_on;

  const minLabel = isHT ? 'HT' : `${minute}'`;
  const minClass = isHT ? 'match-minute ht' : 'match-minute';
  const fid = fx.id;

  return `
  <div class="match-card" data-fid="${fid}" style="animation-delay:${idx*0.15}s" onclick="this.classList.toggle('active')">
  <div class="card-inner">
    <div class="match-header">
      <div class="league-info">
        ${league?.logo ? `<img class="league-logo" src="${league.logo}" onerror="this.style.display='none'">` : ''}
        ${league?.name || ''}
        ${league?.country ? `Â· ${league.country}` : ''}
      </div>
      <div class="${minClass}">${minLabel}</div>
    </div>

    <div class="score-row">
      <div class="team home">
        <div class="team-logo-name">
          ${teams.home.logo ? `<img class="team-logo" src="${teams.home.logo}" onerror="this.style.display='none'">` : ''}
          <div class="team-name">${teams.home.name}</div>
        </div>
        ${hotHome ? '<div class="hot-badge">ğŸ”¥ BASKI YAPAN</div>' : ''}
      </div>

      <div class="score-box">
        <div class="score-num">${goals.home ?? 0}</div>
        <div class="score-sep">â€”</div>
        <div class="score-num">${goals.away ?? 0}</div>
      </div>

      <div class="team away">
        <div class="team-logo-name">
          <div class="team-name">${teams.away.name}</div>
          ${teams.away.logo ? `<img class="team-logo" src="${teams.away.logo}" onerror="this.style.display='none'">` : ''}
        </div>
        ${hotAway ? '<div class="hot-badge">ğŸ”¥ BASKI YAPAN</div>' : ''}
      </div>
    </div>

    <div class="goal-prob-section">
      <div class="goal-prob-label">
        <span>HÃ¼cum â†’ <strong style="color:var(--accent)">${prob.noData ? 'â€”' : prob.home + '%'}</strong></span>
        <span class="tip-wrap">
          Sonraki Gol ${nextGoal === 0 ? '<span class="tag tag-low">VERÄ° YOK</span>' : getProbTag(nextGoal)} <span class="highlight">${nextGoal === 0 ? 'â€”' : nextGoal + '%'}</span>
          <span class="tip-icon">?</span>
          <span class="tip-box">xG hÄ±zÄ±, isabetli ÅŸut ve tehlikeli atak verilerine gÃ¶re hesaplanan tahmini gol ihtimali. Dakika ilerledikÃ§e baskÄ± artarsa yÃ¼kselir.</span>
        </span>
        <span><strong style="color:var(--accent2)">${prob.away}%</strong> â† HÃ¼cum</span>
      </div>
      <div class="prob-track">
        <div class="prob-fill-home" id="ph${fid}" style="width:0%;background:linear-gradient(90deg,rgba(0,229,160,0.6),rgba(0,229,160,0.2))"></div>
        <div class="prob-fill-away" id="pa${fid}" style="width:0%;background:linear-gradient(270deg,rgba(255,77,109,0.6),rgba(255,77,109,0.2))"></div>
      </div>
    </div>

    <div class="stats-row">
      <div class="stat-item">
        <div class="stat-label"><span class="tip-wrap">xG<span class="tip-icon">?</span><span class="tip-box">Beklenen Gol: ÅŸutun kalitesine gÃ¶re gol olasÄ±lÄ±ÄŸÄ±. 2.0 = 2 gol bekleniyordu demek.</span></span></div>
        <div class="stat-values">
          <span class="stat-home live-stat" data-key="xg" data-side="home">${hS.hasRealData ? hS.xg.toFixed(1) : 'â€”'}</span>
          <span class="stat-sep">|</span>
          <span class="stat-away live-stat" data-key="xg" data-side="away">${aS.hasRealData ? aS.xg.toFixed(1) : 'â€”'}</span>
        </div>
      </div>
      <div class="stat-item">
        <div class="stat-label"><span class="tip-wrap">Ä°sabetli Åut<span class="tip-icon">?</span><span class="tip-box">Kaleye yÃ¶nelen ÅŸut sayÄ±sÄ±.</span></span></div>
        <div class="stat-values">
          <span class="stat-home live-stat" data-key="shots_on" data-side="home">${hS.hasRealData ? hS.shots_on : 'â€”'}</span>
          <span class="stat-sep">|</span>
          <span class="stat-away live-stat" data-key="shots_on" data-side="away">${aS.hasRealData ? aS.shots_on : 'â€”'}</span>
        </div>
      </div>
      <div class="stat-item">
        <div class="stat-label"><span class="tip-wrap">Top KontrolÃ¼<span class="tip-icon">?</span><span class="tip-box">Topu elinde tutma yÃ¼zdesi.</span></span></div>
        <div class="stat-values">
          <span class="stat-home live-stat" data-key="possession" data-side="home">${hS.hasRealData ? hS.ball_possession + '%' : 'â€”'}</span>
          <span class="stat-sep">|</span>
          <span class="stat-away live-stat" data-key="possession" data-side="away">${aS.hasRealData ? aS.ball_possession + '%' : 'â€”'}</span>
        </div>
      </div>
      <div class="stat-item">
        <div class="stat-label"><span class="tip-wrap">Teh. Atak<span class="tip-icon">?</span><span class="tip-box">Ceza sahasÄ±na yakÄ±n tehlikeli hÃ¼cum hamleleri.</span></span></div>
        <div class="stat-values">
          <span class="stat-home live-stat" data-key="attacks" data-side="home">${hS.hasRealData ? hS.dangerous_attacks : 'â€”'}</span>
          <span class="stat-sep">|</span>
          <span class="stat-away live-stat" data-key="attacks" data-side="away">${aS.hasRealData ? aS.dangerous_attacks : 'â€”'}</span>
        </div>
      </div>
      <div class="stat-item">
        <div class="stat-label"><span class="tip-wrap">Korner<span class="tip-icon">?</span><span class="tip-box">Korner sayÄ±sÄ±. YÃ¼ksek korner = ceza sahasÄ±nda yoÄŸun baskÄ± demek.</span></span></div>
        <div class="stat-values">
          <span class="stat-home live-stat" data-key="corners" data-side="home">${hS.hasRealData ? hS.corners : 'â€”'}</span>
          <span class="stat-sep">|</span>
          <span class="stat-away live-stat" data-key="corners" data-side="away">${aS.hasRealData ? aS.corners : 'â€”'}</span>
        </div>
      </div>
      <div class="stat-item">
        <div class="stat-label"><span class="tip-wrap">Kart<span class="tip-icon">?</span><span class="tip-box">SarÄ±/kÄ±rmÄ±zÄ± kart sayÄ±sÄ±. YÃ¼ksek kart = maÃ§ sertleÅŸiyor, kart bahsi deÄŸer kazanÄ±yor.</span></span></div>
        <div class="stat-values">
          <span class="stat-home live-stat" data-key="cards" data-side="home">${hS.yellow_cards > 0 || hS.red_cards > 0 ? `<span style="color:#f5c542">${hS.yellow_cards}ğŸŸ¨</span>${hS.red_cards > 0 ? '<span style="color:#ff4d6d"> ' + hS.red_cards + 'ğŸŸ¥</span>' : ''}` : '<span style="color:var(--muted)">â€”</span>'}</span>
          <span class="stat-sep">|</span>
          <span class="stat-away live-stat" data-key="cards" data-side="away">${aS.yellow_cards > 0 || aS.red_cards > 0 ? `<span style="color:#f5c542">${aS.yellow_cards}ğŸŸ¨</span>${aS.red_cards > 0 ? '<span style="color:#ff4d6d"> ' + aS.red_cards + 'ğŸŸ¥</span>' : ''}` : '<span style="color:var(--muted)">â€”</span>'}</span>
        </div>
      </div>
    </div>
  <div class="insight-wrapper">${generateInsight(hS, aS, teams.home.name, teams.away.name, minute, nextGoal, goals.home, goals.away, fid)}</div>
  </div></div>`;
}


// â”€â”€â”€ FÄ°LTRE & SIRALAMA â”€â”€â”€
let allFixturesData = []; // {fixture, stats, prob, nextGoal}

function populateLeagueFilter(fixtures) {
  const sel = document.getElementById('leagueFilter');
  const leagues = [...new Map(fixtures.map(f => [f.fixture.league?.id, f.fixture.league?.name])).entries()];
  leagues.sort((a,b) => a[1]?.localeCompare(b[1]));
  const current = sel.value;
  sel.innerHTML = '<option value="all">ğŸŒ TÃ¼m Ligler (' + fixtures.length + ')</option>';
  leagues.forEach(([id, name]) => {
    if (!name) return;
    const count = fixtures.filter(f => f.fixture.league?.id === id).length;
    const opt = document.createElement('option');
    opt.value = id;
    opt.textContent = name + ' (' + count + ')';
    if (String(id) === String(current)) opt.selected = true;
    sel.appendChild(opt);
  });
}

function applyFilters() {
  const leagueVal = document.getElementById('leagueFilter').value;
  const sortVal   = document.getElementById('sortFilter').value;

  let filtered = allFixturesData.slice();

  if (leagueVal !== 'all') {
    filtered = filtered.filter(d => String(d.fixture.league?.id) === String(leagueVal));
  }

  if (sortVal === 'prob') {
    filtered.sort((a,b) => b.nextGoal - a.nextGoal);
  } else if (sortVal === 'minute') {
    filtered.sort((a,b) => (b.fixture.fixture?.status?.elapsed||0) - (a.fixture.fixture?.status?.elapsed||0));
  } else if (sortVal === 'league') {
    filtered.sort((a,b) => (a.fixture.league?.name||'').localeCompare(b.fixture.league?.name||''));
  }

  // Her filtre render Ã¶ncesi sinyalleri sÄ±fÄ±rla
  window._signals = [];
  document.getElementById('matchCount').textContent = filtered.length + ' maÃ§';
  document.getElementById('matchContainer').innerHTML =
    filtered.length
      ? '<div class="matches">' + filtered.map((d,i) => renderMatch(d.fixture, d.stats, i, d.events)).join('') + '</div>'
      : '<div class="empty-box"><div class="icon">ğŸ”</div><h3>Bu ligde canlÄ± maÃ§ yok</h3></div>';

  setTimeout(() => {
    filtered.forEach(d => {
      const hS = extractStats(d.stats, d.fixture.teams.home.id, d.fixture.goals.home, d.fixture.fixture?.status?.elapsed, d.events);
      const aS = extractStats(d.stats, d.fixture.teams.away.id, d.fixture.goals.away, d.fixture.fixture?.status?.elapsed, d.events);
      const p  = calcGoalProb(hS, aS);
      const ph = document.getElementById('ph' + d.fixture.fixture.id);
      const pa = document.getElementById('pa' + d.fixture.fixture.id);
      if (ph) ph.style.width = p.home + '%';
      if (pa) pa.style.width = p.away + '%';
    });
    // Banner'Ä± gÃ¼ncelle
    setTimeout(updateBanner, 400);
  }, 150);
}

let refreshTimer;

async function loadMatches() {
  const btn = document.getElementById('refreshBtn');
  btn.disabled = true;
  btn.textContent = 'âŸ³ YÃ¼kleniyor...';

  document.getElementById('matchContainer').innerHTML =
    '<div class="loading"><div class="spinner"></div><p>CanlÄ± maÃ§lar Ã§ekiliyor...</p></div>';

  try {
    const data = await fetchAPI('/fixtures?live=all');

    if (!data.response || data.response.length === 0) {
      document.getElementById('matchContainer').innerHTML = `
        <div class="empty-box">
          <div class="icon">âš½</div>
          <h3>Åu an canlÄ± maÃ§ yok</h3>
          <p>MaÃ§lar baÅŸladÄ±ÄŸÄ±nda otomatik olarak burada gÃ¶rÃ¼necek.</p>
        </div>`;
      ['totalGoals','hotMatches','liveCount'].forEach(id => document.getElementById(id).textContent = '0');
      return;
    }

    const fixtures = data.response; 

    // Statistics + Events birlikte Ã§ek (paralel, 120ms aralÄ±k)
    const statsAll  = [];
    const eventsAll = [];
    for (const f of fixtures) {
      try {
        const [sRes, eRes] = await Promise.all([
          fetchAPI(`/fixtures/statistics?fixture=${f.fixture.id}`),
          fetchAPI(`/fixtures/events?fixture=${f.fixture.id}`)
        ]);
        statsAll.push(sRes.response  || []);
        eventsAll.push(eRes.response || []);
      } catch {
        statsAll.push([]);
        eventsAll.push([]);
      }
      await new Promise(res => setTimeout(res, 120));
    }

    // Veriyi global store'a kaydet
    allFixturesData = fixtures.map((f, i) => {
      const ev = eventsAll[i];
      const hS = extractStats(statsAll[i], f.teams.home.id, f.goals.home, f.fixture?.status?.elapsed, ev);
      const aS = extractStats(statsAll[i], f.teams.away.id, f.goals.away, f.fixture?.status?.elapsed, ev);
      return {
        fixture: f,
        stats:   statsAll[i],
        events:  ev,
        nextGoal: calcNextGoalProb(hS, aS, f.fixture?.status?.elapsed)
      };
    });

    // Lig filtresini doldur
    populateLeagueFilter(fixtures.map(f => ({ fixture: f })));

    // MaÃ§ sayÄ±sÄ±
    document.getElementById('matchCount').textContent = fixtures.length + ' maÃ§';

    // Filtreli render
    applyFilters();

    // Ã–zet
    const totalGoals = fixtures.reduce((s, f) => s + (f.goals.home||0) + (f.goals.away||0), 0);
    const hotCount = allFixturesData.filter(d => d.nextGoal >= 65).length;
    document.getElementById('totalGoals').textContent = totalGoals;
    document.getElementById('hotMatches').textContent = hotCount;
    window._signals = [];
    // TÃ¼m maÃ§larÄ± tekrar tarayarak sinyalleri gÃ¼ncelle
    allFixturesData.forEach(d => {
      if (!d.fixture || !d.stats) return;
      const fx  = d.fixture;
      const fid2 = fx.fixture?.id;
      const min2 = fx.fixture?.status?.elapsed || 45;
      const hS2  = extractStats(d.stats, fx.teams.home.id, fx.goals.home, min2, d.events);
      const aS2  = extractStats(d.stats, fx.teams.away.id, fx.goals.away, min2, d.events);
      const ng2  = calcNextGoalProb(hS2, aS2, min2);
      generateInsight(hS2, aS2, fx.teams.home.name, fx.teams.away.name, min2, ng2, fx.goals.home, fx.goals.away, fid2);
    });
    updateBanner();
    document.getElementById('liveCount').textContent = fixtures.length;

  } catch(e) {
    console.error(e);
    document.getElementById('matchContainer').innerHTML = `
      <div class="error-box">
        <h3>ğŸ”´ BaÄŸlantÄ± HatasÄ±</h3>
        <p>Hata: ${e.message}<br><br>
        API key'ini kontrol et veya tarayÄ±cÄ±da CORS sorununu aÅŸmak iÃ§in siteyi bir sunucudan aÃ§.<br>
        <small>Not: HTML dosyasÄ±nÄ± doÄŸrudan tarayÄ±cÄ±dan aÃ§arsan CORS hatasÄ± alabilirsin. Bir web sunucusu Ã¼zerinden Ã§alÄ±ÅŸtÄ±r.</small>
        </p>
      </div>`;
  }

  btn.disabled = false;
  btn.textContent = 'âŸ³ Yenile';
}

// Saat
setInterval(() => {
  document.getElementById('clock').textContent =
    new Date().toLocaleTimeString('tr-TR', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
}, 1000);
document.getElementById('clock').textContent =
  new Date().toLocaleTimeString('tr-TR', { hour:'2-digit', minute:'2-digit', second:'2-digit' });

// â”€â”€ EN Ä°YÄ° SÄ°NYAL BANNERINI GÃœNCELLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ TELEGRAM AYARLARI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TG_BOT_TOKEN  = '8541693658:AAESplLat1zjXuJvFpUtqorLA0XVWxb3oFk';   // @BotFather'dan
const TG_CHANNEL_ID = '@canlitahminci';        // Ã¶rn: @canlitahminci

// Aktif fÄ±rsat takibi
let _activeFirsat  = null;   // { key, label, match, minute, fixtureId, startGoals }
const _sentKeys    = new Set();

async function sendTelegram(text) {
  if (!TG_BOT_TOKEN || TG_BOT_TOKEN.includes('BURAYA')) return;
  try {
    await fetch(`https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chat_id: TG_CHANNEL_ID,
        text,
        parse_mode: 'HTML',
        disable_web_page_preview: true
      })
    });
  } catch(e) { console.warn('Telegram hata:', e); }
}

function buildNewMsg(signal) {
  const now = new Date().toLocaleTimeString('tr-TR', { hour:'2-digit', minute:'2-digit' });
  const typeEmoji = {
    gol:'âš½', kg:'ğŸ”µ', korner:'ğŸš©', kart:'ğŸŸ¨'
  }[signal.type || 'gol'] || 'ğŸ”¥';
  return (
    `ğŸ”¥ <b>YENÄ° FIRSAT â€” ${now}</b>
` +
    `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
` +
    `${typeEmoji} <b>${(signal.label||'').toUpperCase()}</b>

` +
    `âš½ <b>${signal.match}</b>
` +
    `â± ${signal.minute || '?'}. dakika

` +
    `ğŸ“Š <i>${signal.why}</i>

` +
    `ğŸ‘‰ <b>Hemen oyna:</b> https://gir.gg/cevdet`
  );
}

function buildResolvedMsg(firsat, result) {
  const now = new Date().toLocaleTimeString('tr-TR', { hour:'2-digit', minute:'2-digit' });
  const statusLine = result === 'won'
    ? 'âœ… <b>KAZANDI</b> â€” Tahmin doÄŸru Ã§Ä±ktÄ±!'
    : result === 'lost'
    ? 'âŒ <b>KAYBETTI</b> â€” Bu sefer olmadÄ±.'
    : 'ğŸ <b>SONA ERDÄ°</b> â€” MaÃ§ bitti veya koÅŸullar deÄŸiÅŸti.';
  return (
    `${statusLine}
` +
    `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
` +
    `<b>${firsat.label}</b> | ${firsat.match}
` +
    `â± ${now}

` +
    `â¬‡ï¸ Yeni fÄ±rsat aranÄ±yor...`
  );
}

// Aktif fÄ±rsatÄ±n ÅŸu an kazanÄ±lÄ±p kazanÄ±lmadÄ±ÄŸÄ±nÄ± maÃ§ iÃ§inde kontrol et
function evaluateFirsat(firsat) {
  const d = allFixturesData.find(d => d.fixture?.fixture?.id === firsat.fixtureId);
  if (!d) return 'finished'; // MaÃ§ listeden dÃ¼ÅŸtÃ¼

  const status = d.fixture?.fixture?.status?.short || '';
  const hg     = d.fixture?.goals?.home || 0;
  const ag     = d.fixture?.goals?.away || 0;
  const total  = hg + ag;
  const label  = firsat.label || '';
  const type   = firsat.type  || '';

  // â”€â”€ KART bahsi â€” maÃ§ bitmeden de kazanÄ±labilir â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (type === 'kart' || label.toLowerCase().includes('kart')) {
    // Mevcut kart sayÄ±sÄ±nÄ± istatistiklerden al
    let yellow = 0, red = 0;
    (d.stats || []).forEach(side => {
      (side.statistics || []).forEach(st => {
        const t = (st.type || '').toLowerCase();
        const v = parseInt(st.value) || 0;
        if (t.includes('yellow card'))   yellow = Math.max(yellow, v);
        if (t.includes('red card'))      red    = Math.max(red, v);
      });
    });
    const cards     = yellow + red * 2;
    const threshold = parseFloat(label); // "5.5 Ãœst Kart" â†’ 5.5
    if (!isNaN(threshold) && cards >= threshold + 0.5) return 'won';
    // MaÃ§ bitti ve eÅŸik aÅŸÄ±lmadÄ±
    if (['FT','AET','PEN'].includes(status)) return 'lost';
    return 'ongoing';
  }

  // â”€â”€ KORNER bahsi â€” maÃ§ bitmeden de kazanÄ±labilir â”€â”€â”€â”€â”€â”€â”€â”€
  if (type === 'korner' || label.toLowerCase().includes('korner')) {
    let corners = 0;
    (d.stats || []).forEach(side => {
      (side.statistics || []).forEach(st => {
        if ((st.type || '').toLowerCase().includes('corner')) {
          corners += parseInt(st.value) || 0;
        }
      });
    });
    const threshold = parseFloat(label); // "9.5 Ãœst Korner" â†’ 9.5
    if (!isNaN(threshold) && corners >= threshold + 0.5) return 'won';
    if (['FT','AET','PEN'].includes(status)) return 'lost';
    return 'ongoing';
  }

  // â”€â”€ GOL bahsi â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (type === 'gol' || label.includes('Ãœst') || label.includes('Gol')) {
    const threshold = parseFloat(label); // "2.5 Ãœst" â†’ 2.5
    if (!isNaN(threshold) && total > threshold) return 'won';
    if (['FT','AET','PEN'].includes(status)) {
      return total > threshold ? 'won' : 'lost';
    }
    return 'ongoing';
  }

  // â”€â”€ KG VAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (type === 'kg' || label.includes('KG Var')) {
    if (hg > 0 && ag > 0) return 'won';
    if (['FT','AET','PEN'].includes(status)) return 'lost';
    return 'ongoing';
  }

  // MaÃ§ bitti ama tip bilinmiyor
  if (['FT','AET','PEN'].includes(status)) return 'finished';
  return 'ongoing';
}

function checkFirsatOutcome(topKey) {
  if (!_activeFirsat) return;

  // HÃ¢lÃ¢ aynÄ± fÄ±rsat mÄ±? â†’ Ã–nce kazanÄ±ldÄ± mÄ± kontrol et
  const result = evaluateFirsat(_activeFirsat);

  if (result === 'won' || result === 'lost' || result === 'finished') {
    sendTelegram(buildResolvedMsg(_activeFirsat, result));
    _activeFirsat = null;
    return;
  }

  // FÄ±rsat deÄŸiÅŸti (farklÄ± maÃ§/tip Ã¶ne geÃ§ti) â†’ eski bitti
  if (topKey && topKey !== _activeFirsat.key) {
    sendTelegram(buildResolvedMsg(_activeFirsat, 'finished'));
    _activeFirsat = null;
  }
}

// â”€â”€ YAPAY ZEKA ANALÄ°ZÄ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _lastAIKey  = null;   // Son analiz yapÄ±lan sinyal key
let _aiRunning  = false;  // EÅŸzamanlÄ± Ã§aÄŸrÄ± engeli

// Ä°statistik context oluÅŸtur
function buildStatsContext(sig) {
  const fid   = sig.fixtureId;
  const match = fid ? allFixturesData.find(d => d.fixture?.fixture?.id === fid) : null;
  if (!match?.stats?.length) return { stats: '', fx: null };
  const fx  = match.fixture;
  const hg  = fx?.goals?.home ?? 0;
  const ag  = fx?.goals?.away ?? 0;
  const min = sig.minute || fx?.fixture?.status?.elapsed || 45;
  const hS  = extractStats(match.stats, fx.teams.home.id, hg, min, match.events);
  const aS  = extractStats(match.stats, fx.teams.away.id, ag, min, match.events);
  if (!hS.hasRealData && !aS.hasRealData) return { stats: '', fx };
  const stats = `xG: ${hS.xg.toFixed(2)}/${aS.xg.toFixed(2)} | Åut: ${hS.shots_on}/${aS.shots_on} | Atak: ${hS.dangerous_attacks}/${aS.dangerous_attacks} | Top: %${hS.ball_possession}/%${aS.ball_possession} | Korner: ${hS.corners}/${aS.corners} | SarÄ±: ${hS.yellow_cards}/${aS.yellow_cards} | KÄ±rmÄ±zÄ±: ${hS.red_cards}/${aS.red_cards} | Faul: ${hS.fouls}/${aS.fouls}`;
  return { stats, fx };
}

async function callClaude(prompt, maxTokens) {
  const resp = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      model: 'claude-sonnet-4-6',
      max_tokens: maxTokens || 300,
      messages: [{ role: 'user', content: prompt }]
    })
  });
  const data = await resp.json();
  return (data.content || []).map(b => b.text || '').join('').trim();
}

function formatAIText(text) {
  return text
    .replace(/ğŸ“Š/g, '<span style="color:var(--blue)">ğŸ“Š</span>')
    .replace(/âš ï¸/g,  '<span style="color:var(--gold)">âš ï¸</span>')
    .replace(/âœ…/g,  '<span style="color:var(--green)">âœ…</span>')
    .replace(/âŒ/g,  '<span style="color:var(--red)">âŒ</span>')
    .replace(/(GÄ°R)/g,   '<em style="color:var(--green);font-weight:800">GÄ°R</em>')
    .replace(/(BEKLE)/g, '<em style="color:var(--gold);font-weight:800">BEKLE</em>')
    .replace(/(ATLA)/g,  '<em style="color:var(--red);font-weight:800">ATLA</em>')
    .replace(/
/g, '<br>');
}

// Claude gÃ¶rev 1: DetaylÄ± bahis analizi
async function fetchAIAnalysis(sig) {
  const { stats, fx } = buildStatsContext(sig);
  const hg     = fx?.goals?.home ?? '?';
  const ag     = fx?.goals?.away ?? '?';
  const min    = sig.minute || fx?.fixture?.status?.elapsed || '?';
  const league = fx?.league?.name || '';
  const prompt = `Sen bir profesyonel canlÄ± bahis analistisisin. TÃ¼rkÃ§e, kÄ±sa ve net yaz.
MaÃ§: ${sig.match} | Lig: ${league} | ${min}. dakika | Skor: ${hg}-${ag}
Ã–neri: ${sig.label} | GerekÃ§e: ${sig.why || ''}
Ä°statistikler (Ev/Dep): ${stats || 'Yok'}

Åu formatÄ± AYNEN kullan:
ğŸ“Š [2 cÃ¼mle â€” neden bu bahis mantÄ±klÄ±]
âš ï¸ Risk: [1 cÃ¼mle]
âœ… Karar: GÄ°R / BEKLE / ATLA â€” [1 cÃ¼mle gerekÃ§e]`;
  return callClaude(prompt, 280);
}

// Claude gÃ¶rev 2: KÄ±sa ikna edici banner hint
async function fetchAIBannerHint(sig) {
  const { stats, fx } = buildStatsContext(sig);
  const min    = sig.minute || fx?.fixture?.status?.elapsed || '?';
  const prompt = `CanlÄ± bahis uygulamasÄ± iÃ§in Ã‡ARPICI 1 cÃ¼mlelik TÃ¼rkÃ§e banner metni yaz.
MaÃ§: ${sig.match} | ${min}. dakika | Ã–neri: ${sig.label}
Veri: ${sig.why || ''} | ${stats || ''}
KURAL: Sadece 1 cÃ¼mle. Max 12 kelime. Rakam kullan. "!" koy. Aciliyet hissi ver.
Ã–rnek: "7 korner + projeksiyon 11.4 â€” 9.5 Ãœst iÃ§in mÃ¼kemmel an!"
SADECE cÃ¼mleyi yaz, baÅŸka hiÃ§bir ÅŸey yok.`;
  return callClaude(prompt, 80);
}

// 30sn dÃ¶ngÃ¼sÃ¼nde sinyal deÄŸiÅŸince Ã§aÄŸrÄ±lÄ±r
function maybeRunAI(top) {
  if (!top) return;
  const key = top.key || `${top.match}__${top.label}`;
  if (key === _lastAIKey) return;  // AynÄ± sinyal, tekrar Ã§aÄŸÄ±rma
  runAIAnalysis(top);
}

async function runAIAnalysis(signal) {
  if (_aiRunning) return;
  const sig = signal || _activeFirsat || (window._signals||[]).sort((a,b)=>b.score-a.score)[0];
  if (!sig) return;

  const key = sig.key || `${sig.match}__${sig.label}`;
  if (key === _lastAIKey && signal === undefined) return;  // Manuel refresh hariÃ§ tekrar Ã§aÄŸÄ±rma

  _aiRunning  = true;
  _lastAIKey  = key;

  const panel       = document.getElementById('ai-panel');
  const textEl      = document.getElementById('ai-panel-text');
  const contextEl   = document.getElementById('ai-panel-context');
  const refreshBtn  = document.getElementById('ai-refresh-btn');
  const aiBannerBtn = document.getElementById('banner-ai-btn');
  const hintEl      = document.getElementById('banner-reason');

  panel.classList.add('show');
  textEl.className  = 'ai-panel-text loading';
  textEl.innerHTML  = '<div class="ai-spinner"></div> Analiz yapÄ±lÄ±yor...';
  contextEl.textContent = `${sig.match} Â· ${sig.minute||'?'}. dakika Â· ${sig.label}`;
  if (refreshBtn)  refreshBtn.disabled = true;
  if (aiBannerBtn) { aiBannerBtn.disabled = true; aiBannerBtn.textContent = 'âŸ³'; }

  try {
    // Ä°ki gÃ¶revi paralel Ã§alÄ±ÅŸtÄ±r
    const [analysisText, bannerHint] = await Promise.all([
      fetchAIAnalysis(sig),
      fetchAIBannerHint(sig)
    ]);

    // 1. DetaylÄ± analiz â†’ AI paneli
    textEl.className = 'ai-panel-text';
    textEl.innerHTML = analysisText
      ? formatAIText(analysisText)
      : '<span style="color:var(--muted)">Analiz alÄ±namadÄ±.</span>';

    // 2. KÄ±sa hint â†’ banner alt metni
    if (bannerHint && hintEl) {
      hintEl.textContent = bannerHint.replace(/^["']|["']$/g, '').trim();
    }

    // 3. Telegram'a da gÃ¶nder (sadece aktif fÄ±rsat ise)
    if (analysisText && sig.key && sig.key === _activeFirsat?.key) {
      sendTelegram(
        `ğŸ¤– <b>AI ANALÄ°ZÄ°</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
` +
        `<b>${sig.match}</b> Â· ${sig.minute||'?'}. dakika

` +
        `<i>${analysisText.replace(/<[^>]+>/g,'')}</i>`
      );
    }

  } catch(e) {
    textEl.className = 'ai-panel-text';
    textEl.innerHTML = '<span style="color:var(--muted)">BaÄŸlantÄ± hatasÄ±.</span>';
    console.error('AI hata:', e);
  } finally {
    _aiRunning = false;
    if (refreshBtn)  refreshBtn.disabled = false;
    if (aiBannerBtn) { aiBannerBtn.disabled = false; aiBannerBtn.textContent = 'ğŸ¤– AI Analizi'; }
  }
}

function updateBanner()function updateBanner() {
  const signals = window._signals || [];
  const banner  = document.getElementById('opportunity-banner');
  if (!banner) return;
  if (signals.length === 0) { banner.classList.remove('show'); return; }

  signals.sort((a, b) => b.score - a.score);
  const top = signals[0];
  const key = `${top.match}__${top.label}`;
  top.key   = key;

  // Banner DOM gÃ¼ncelle
  document.getElementById('banner-match').innerHTML    = top.match || 'â€”';
  document.getElementById('banner-action').textContent = top.label || 'â€”';
  document.getElementById('banner-reason').textContent = top.why   || 'â€”';
  banner.classList.add('show');

  // 1. Aktif fÄ±rsatÄ±n sonucunu kontrol et (kazandÄ± mÄ±, deÄŸiÅŸti mi)
  checkFirsatOutcome(key);

  // Her dÃ¶ngÃ¼de: sinyal deÄŸiÅŸtiyse AI'Ä± tetikle (Telegram gÃ¶ndermeden)
  maybeRunAI(top);

  // 2. Daha Ã¶nce gÃ¶nderildi mi?
  if (_sentKeys.has(key)) return;

  // 3. Yeni fÄ±rsat â†’ gÃ¶nder
  _sentKeys.add(key);
  _activeFirsat = { key, label: top.label, match: top.match,
    minute: top.minute, fixtureId: top.fixtureId, type: top.type };
  sendTelegram(buildNewMsg(top));

  // Yeni fÄ±rsat = AI analizini otomatik Ã§alÄ±ÅŸtÄ±r
  setTimeout(() => runAIAnalysis(top), 800);
}

async function updateStatsOnly() {
  if (!allFixturesData.length) return;
  if (document.getElementById('refreshBtn').disabled) return;

  try {
    // Cache sunucusu varsa ondan oku
    const cacheResult = await fetchCacheServer();
    if (cacheResult && cacheResult.fixtures && cacheResult.fixtures.length) {
      // Cache'den taze veriyi al
      const lastUpd = cacheResult.lastUpdate
        ? new Date(cacheResult.lastUpdate).toLocaleTimeString('tr-TR')
        : 'â€”';
      document.getElementById('clock').textContent = lastUpd;

      // allFixturesData'yÄ± gÃ¼ncelle
      const newMap = {};
      cacheResult.fixtures.forEach(d => {
        newMap[d.fixture?.fixture?.id] = d;
      });

      allFixturesData = allFixturesData.map(d => {
        const fid = d.fixture?.fixture?.id;
        return newMap[fid] ? { fixture: newMap[fid].fixture, stats: newMap[fid].stats, events: newMap[fid].events } : d;
      });

      applyFilters();

      // Ã–zet sayaÃ§larÄ± gÃ¼ncelle
      let hotCount = 0, goalCount = 0;
      allFixturesData.forEach(d => {
        if (!d.fixture) return;
        goalCount += (d.fixture.goals?.home || 0) + (d.fixture.goals?.away || 0);
        const min2 = d.fixture.fixture?.status?.elapsed || 45;
        const hS2  = extractStats(d.stats, d.fixture.teams?.home?.id, d.fixture.goals?.home, min2, d.events);
        const aS2  = extractStats(d.stats, d.fixture.teams?.away?.id, d.fixture.goals?.away, min2, d.events);
        const ng2  = calcNextGoalProb(hS2, aS2, min2);
        if (ng2 >= 65) hotCount++;
      });
      document.getElementById('hotMatches').textContent = hotCount;
      document.getElementById('totalGoals').textContent = goalCount;
      document.getElementById('liveCount').textContent  = allFixturesData.length;

      window._signals = [];
      allFixturesData.forEach(d => {
        if (!d.fixture || !d.stats) return;
        const fx   = d.fixture;
        const fid2 = fx.fixture?.id;
        const min2 = fx.fixture?.status?.elapsed || 45;
        const hS2  = extractStats(d.stats, fx.teams.home.id, fx.goals.home, min2, d.events);
        const aS2  = extractStats(d.stats, fx.teams.away.id, fx.goals.away, min2, d.events);
        const ng2  = calcNextGoalProb(hS2, aS2, min2);
        generateInsight(hS2, aS2, fx.teams.home.name, fx.teams.away.name, min2, ng2, fx.goals.home, fx.goals.away, fid2);
      });
      updateBanner();
      return;
    }

    // Fallback: direkt API
    const data = await fetchAPI('/fixtures?live=all');
    if (!data.response) return;

    const freshMap = {};
    data.response.forEach(f => { freshMap[f.fixture.id] = f; });

    // 2. Her maÃ§ iÃ§in yeni stats Ã§ek ve DOM'u gÃ¼ncelle
    for (const d of allFixturesData) {
      const fresh = freshMap[d.fixture.fixture.id];
      if (!fresh) continue;

      // Fixture gÃ¼ncelle
      d.fixture = fresh;
      const fid = fresh.fixture.id;
      const min = fresh.fixture?.status?.elapsed;
      const sh  = fresh.fixture?.status?.short;

      // Taze statistics + events paralel Ã§ek
      let freshStats  = d.stats;
      let freshEvents = d.events || [];
      try {
        const [sr, er] = await Promise.all([
          fetchAPI(`/fixtures/statistics?fixture=${fid}`),
          fetchAPI(`/fixtures/events?fixture=${fid}`)
        ]);
        if (sr.response && sr.response.length > 0) { freshStats = sr.response;  d.stats  = freshStats; }
        if (er.response && er.response.length > 0)  { freshEvents = er.response; d.events = freshEvents; }
      } catch(e) {}
      await new Promise(r => setTimeout(r, 120));

      const hS   = extractStats(freshStats, fresh.teams.home.id, fresh.goals.home, min, freshEvents);
      const aS   = extractStats(freshStats, fresh.teams.away.id, fresh.goals.away, min, freshEvents);
      const prob = calcGoalProb(hS, aS);
      const ng   = calcNextGoalProb(hS, aS, min);
      d.nextGoal = ng;

      // â”€â”€ Dakika â”€â”€
      const minEl = document.querySelector(`[data-fid="${fid}"] .match-minute`);
      if (minEl) {
        minEl.textContent = sh === 'HT' ? 'HT' : (min + "'");
        minEl.className   = sh === 'HT' ? 'match-minute ht' : 'match-minute';
      }

      // â”€â”€ Skor â”€â”€
      const scoreEls = document.querySelectorAll(`[data-fid="${fid}"] .score-num`);
      if (scoreEls.length === 2) {
        const newH = fresh.goals.home ?? 0;
        const newA = fresh.goals.away ?? 0;
        if (scoreEls[0].textContent != newH || scoreEls[1].textContent != newA) {
          scoreEls[0].textContent = newH;
          scoreEls[1].textContent = newA;
          [scoreEls[0], scoreEls[1]].forEach(el => {
            el.style.color = 'var(--accent3)';
            el.style.transform = 'scale(1.15)';
            setTimeout(() => { el.style.color = ''; el.style.transform = ''; }, 1400);
          });
        }
      }

      // â”€â”€ Prob barlarÄ± â”€â”€
      const ph = document.getElementById('ph' + fid);
      const pa = document.getElementById('pa' + fid);
      if (ph) ph.style.width = prob.home + '%';
      if (pa) pa.style.width = prob.away + '%';

      // â”€â”€ Ä°statistik deÄŸerleri (fade animasyonu ile) â”€â”€
      const statMap = {
        xg:         { home: hS.hasRealData ? hS.xg.toFixed(1) : 'â€”', away: aS.hasRealData ? aS.xg.toFixed(1) : 'â€”' },
        shots_on:   { home: hS.hasRealData ? String(hS.shots_on) : 'â€”', away: aS.hasRealData ? String(aS.shots_on) : 'â€”' },
        possession: { home: hS.hasRealData ? hS.ball_possession + '%' : 'â€”', away: aS.hasRealData ? aS.ball_possession + '%' : 'â€”' },
        attacks:    { home: hS.hasRealData ? String(hS.dangerous_attacks) : 'â€”', away: aS.hasRealData ? String(aS.dangerous_attacks) : 'â€”' },
        corners:    { home: hS.hasRealData ? String(hS.corners) : 'â€”', away: aS.hasRealData ? String(aS.corners) : 'â€”' },
        cards: {
          home: hS.yellow_cards > 0 || hS.red_cards > 0
            ? `<span style="color:#f5c542">${hS.yellow_cards}ğŸŸ¨</span>${hS.red_cards > 0 ? ` <span style="color:#ff4d6d">${hS.red_cards}ğŸŸ¥</span>` : ''}`
            : '<span style="color:var(--muted)">â€”</span>',
          away: aS.yellow_cards > 0 || aS.red_cards > 0
            ? `<span style="color:#f5c542">${aS.yellow_cards}ğŸŸ¨</span>${aS.red_cards > 0 ? ` <span style="color:#ff4d6d">${aS.red_cards}ğŸŸ¥</span>` : ''}`
            : '<span style="color:var(--muted)">â€”</span>'
        }
      };

      document.querySelectorAll(`[data-fid="${fid}"] .live-stat`).forEach(el => {
        const key  = el.dataset.key;
        const side = el.dataset.side;
        const newVal = statMap[key]?.[side];
        if (newVal === undefined) return;
        // Kart iÃ§in innerHTML (HTML iÃ§eriÄŸi var)
        if (key === 'cards') {
          if (el.innerHTML !== String(newVal)) {
            el.style.opacity = '0';
            setTimeout(() => { el.innerHTML = String(newVal); el.style.opacity = '1'; }, 280);
          }
          return;
        }
        const newStr = String(newVal);
        if (el.textContent !== newStr) {
          el.style.transition = 'opacity 0.3s, color 0.4s';
          el.style.opacity    = '0';
          setTimeout(() => {
            el.textContent   = newStr;
            el.style.opacity = '1';
            el.style.color   = 'var(--accent3)';
            setTimeout(() => el.style.color = '', 800);
          }, 300);
        }
      });

      // â”€â”€ Insight kutucuÄŸu â”€â”€
      const insightEl = document.querySelector(`[data-fid="${fid}"] .insight-wrapper`);
      if (insightEl) {
        insightEl.style.opacity = '0.5';
        setTimeout(() => {
          insightEl.innerHTML = generateInsight(
            hS, aS,
            fresh.teams.home.name, fresh.teams.away.name,
            min, ng, fresh.goals.home, fresh.goals.away
          );
          insightEl.style.opacity = '1';
        }, 350);
      }
    }

    // â”€â”€ Sinyal banner â”€â”€
    setTimeout(updateBanner, 500);

    // â”€â”€ Ã–zet â”€â”€
    const totalGoals = allFixturesData.reduce((s,d) => s + (d.fixture.goals.home||0) + (d.fixture.goals.away||0), 0);
    const hotCount   = allFixturesData.filter(d => d.nextGoal >= 65).length;
    document.getElementById('totalGoals').textContent = totalGoals;
    document.getElementById('hotMatches').textContent = hotCount;
    window._signals = [];
    // TÃ¼m maÃ§larÄ± tekrar tarayarak sinyalleri gÃ¼ncelle
    allFixturesData.forEach(d => {
      if (!d.fixture || !d.stats) return;
      const fx = d.fixture; const min2 = fx.fixture?.status?.elapsed || 45;
      const hS2 = extractStats(d.stats, fx.teams.home.id, fx.goals.home, min2, d.events);
      const aS2 = extractStats(d.stats, fx.teams.away.id, fx.goals.away, min2, d.events);
      const ng2  = calcNextGoalProb(hS2, aS2, min2);
      generateInsight(hS2, aS2, fx.teams.home.name, fx.teams.away.name, min2, ng2, fx.goals.home, fx.goals.away);
    });
    updateBanner();

  } catch(e) {
    console.warn('CanlÄ± gÃ¼ncelleme hatasÄ±:', e.message);
  }
}

// Her 30sn'de canlÄ± gÃ¼ncelle, her 10 dakikada tam yenile
setInterval(updateStatsOnly, 30000);
setInterval(() => {
  if (!document.getElementById('refreshBtn').disabled) loadMatches();
}, 600000);

loadMatches();

// 3 saniye sonra telegram popup gÃ¶ster (sadece 1 kez)
if (!sessionStorage.getItem('tgShown')) {
  setTimeout(() => {
    document.getElementById('tgPopup').classList.add('show');
    sessionStorage.setItem('tgShown', '1');
  }, 3000);
}
</script>


</body>
</html>
